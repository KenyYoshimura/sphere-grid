<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WG Sphere Grid - ä¼æ¥­ã‚¹ãƒ•ã‚£ã‚¢ç›¤</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: #050812;
      font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
      overflow: hidden;
    }

    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    #login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #050812 0%, #0A1628 50%, #051020 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    #login-screen.hidden {
      display: none;
    }
    .login-box {
      background: rgba(10, 22, 40, 0.95);
      border: 1px solid rgba(74, 122, 184, 0.4);
      border-radius: 16px;
      padding: 40px 50px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(74, 122, 184, 0.1);
    }
    .login-logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: radial-gradient(circle at 30% 30%, #FFE066, #B88A08);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 32px;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
    }
    .login-box h1 {
      color: #FFD700;
      font-size: 24px;
      letter-spacing: 3px;
      margin-bottom: 8px;
    }
    .login-box .subtitle {
      color: #889;
      font-size: 14px;
      margin-bottom: 30px;
    }
    .login-box input[type="password"] {
      width: 100%;
      padding: 14px 20px;
      background: rgba(20, 40, 60, 0.8);
      border: 1px solid rgba(74, 122, 184, 0.3);
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      text-align: center;
      letter-spacing: 4px;
      margin-bottom: 16px;
    }
    .login-box input[type="password"]:focus {
      outline: none;
      border-color: #FFD700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
    }
    .login-box input[type="password"]::placeholder {
      letter-spacing: 0;
      color: #556;
    }
    .login-box button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #B88A08, #FFD700);
      border: none;
      border-radius: 8px;
      color: #000;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .login-box button:hover {
      background: linear-gradient(135deg, #FFD700, #FFE44D);
      box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
    }
    .login-error {
      color: #E64D66;
      font-size: 13px;
      margin-top: 12px;
      min-height: 20px;
    }
    .login-hint {
      color: #556;
      font-size: 11px;
      margin-top: 20px;
    }

    /* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ */
    #logout-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(100, 100, 120, 0.3);
      border: 1px solid rgba(100, 100, 120, 0.5);
      color: #889;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      z-index: 100;
    }
    #logout-btn:hover {
      background: rgba(230, 77, 102, 0.3);
      border-color: rgba(230, 77, 102, 0.5);
      color: #E64D66;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆéè¡¨ç¤ºåˆæœŸçŠ¶æ…‹ï¼‰ */
    #main-content {
      display: none;
    }
    #main-content.visible {
      display: block;
    }
    #container {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    canvas {
      display: block;
    }
    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
    #tooltip {
      position: absolute;
      display: none;
      background: rgba(10, 16, 36, 0.95);
      border: 1px solid rgba(74, 122, 184, 0.5);
      border-radius: 8px;
      padding: 12px 16px;
      color: #fff;
      font-size: 12px;
      max-width: 280px;
      pointer-events: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      z-index: 1000;
    }
    #tooltip h3 {
      color: #FFD700;
      font-size: 14px;
      margin-bottom: 8px;
    }
    #tooltip .state {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      margin-bottom: 8px;
    }
    #tooltip .state.MASTERED { background: rgba(255,215,0,0.3); color: #FFD700; }
    #tooltip .state.UNLOCKED { background: rgba(51,230,128,0.3); color: #33E680; }
    #tooltip .state.ELIGIBLE { background: rgba(255,215,0,0.2); color: #FFD700; }
    #tooltip .state.LOCKED { background: rgba(100,100,120,0.3); color: #888; }
    #tooltip .description { color: #aab; margin-bottom: 8px; }
    #tooltip .requirements { margin-top: 8px; }
    #tooltip .requirements h4 { color: #B88A08; font-size: 11px; margin-bottom: 4px; }
    #tooltip .sphere-item {
      display: inline-block;
      margin: 2px 4px 2px 0;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
    }
    #tooltip .effect { color: #4DCC80; margin-top: 8px; font-size: 11px; }

    /* å‡¡ä¾‹ */
    #legend {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(10, 16, 36, 0.9);
      border: 1px solid rgba(74, 122, 184, 0.4);
      border-radius: 12px;
      padding: 16px 20px;
      color: #fff;
      font-size: 11px;
      min-width: 280px;
    }
    #legend h2 {
      color: #FFD700;
      font-size: 14px;
      margin-bottom: 12px;
    }
    #legend h3 {
      color: #B88A08;
      font-size: 11px;
      margin: 12px 0 8px 0;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 6px 0;
    }
    .legend-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 10px;
      flex-shrink: 0;
    }
    .legend-sphere {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      flex-shrink: 0;
    }
    .legend-text {
      flex: 1;
    }
    .legend-text .label { color: #fff; }
    .legend-text .desc { color: #889; font-size: 10px; }

    /* ã‚²ãƒ¼ãƒˆæ¡ä»¶ */
    #gates {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(10, 16, 36, 0.9);
      border: 1px solid rgba(74, 122, 184, 0.4);
      border-radius: 12px;
      padding: 16px 20px;
      color: #fff;
      font-size: 11px;
      max-width: 280px;
    }
    #gates h2 {
      color: #FFD700;
      font-size: 16px;
      letter-spacing: 2px;
      margin-bottom: 4px;
    }
    #gates .subtitle {
      color: #889;
      font-size: 12px;
      margin-bottom: 12px;
    }
    #gates h3 {
      color: #B88A08;
      font-size: 11px;
      margin-bottom: 8px;
    }
    #gates ul {
      list-style: none;
      color: #aab;
      line-height: 1.8;
    }
    #gates li::before {
      content: "ãƒ»";
      color: #4A7AB8;
    }

    /* ã‚¨ãƒ‡ã‚£ã‚¿ãƒ‘ãƒãƒ« */
    #editor-toggle {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid #FFD700;
      color: #FFD700;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    #editor-toggle:hover {
      background: rgba(255, 215, 0, 0.3);
    }

    #editor-panel {
      position: absolute;
      top: 0;
      right: -450px;
      width: 450px;
      height: 100vh;
      background: rgba(10, 16, 36, 0.98);
      border-left: 1px solid rgba(74, 122, 184, 0.5);
      padding: 20px;
      overflow-y: auto;
      transition: right 0.3s ease;
      z-index: 2000;
    }
    #editor-panel.open {
      right: 0;
    }
    #editor-panel h2 {
      color: #FFD700;
      font-size: 18px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #editor-panel .close-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
    }
    #editor-panel .close-btn:hover {
      color: #fff;
    }

    .editor-section {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(74, 122, 184, 0.2);
    }
    .editor-section h3 {
      color: #B88A08;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .node-list {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 12px;
    }
    .node-list-item {
      display: flex;
      align-items: center;
      padding: 8px;
      margin: 4px 0;
      background: rgba(74, 122, 184, 0.1);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .node-list-item:hover {
      background: rgba(74, 122, 184, 0.2);
    }
    .node-list-item.selected {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid rgba(255, 215, 0, 0.5);
    }
    .node-list-item .node-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .node-list-item .node-name {
      color: #fff;
      flex: 1;
    }
    .node-list-item .node-state {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .form-group {
      margin-bottom: 12px;
    }
    .form-group label {
      display: block;
      color: #889;
      font-size: 11px;
      margin-bottom: 4px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px 12px;
      background: rgba(20, 30, 50, 0.8);
      border: 1px solid rgba(74, 122, 184, 0.3);
      border-radius: 6px;
      color: #fff;
      font-size: 13px;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #FFD700;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 60px;
    }
    .form-row {
      display: flex;
      gap: 12px;
    }
    .form-row .form-group {
      flex: 1;
    }

    .sphere-editor {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .sphere-tag {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }
    .sphere-tag input {
      width: 30px;
      padding: 2px 4px;
      margin-left: 4px;
      text-align: center;
      font-size: 11px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #FFD700;
      color: #000;
    }
    .btn-primary:hover {
      background: #FFE44D;
    }
    .btn-secondary {
      background: rgba(74, 122, 184, 0.3);
      color: #fff;
      border: 1px solid rgba(74, 122, 184, 0.5);
    }
    .btn-secondary:hover {
      background: rgba(74, 122, 184, 0.5);
    }
    .btn-danger {
      background: rgba(230, 77, 102, 0.3);
      color: #E64D66;
      border: 1px solid rgba(230, 77, 102, 0.5);
    }
    .btn-danger:hover {
      background: rgba(230, 77, 102, 0.5);
      color: #fff;
    }
    .btn-group {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    /* ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ */
    #export-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(74, 122, 184, 0.2);
    }
    #export-section h3 {
      color: #B88A08;
      font-size: 14px;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <div id="login-screen">
    <div class="login-box">
      <div class="login-logo">âš¡</div>
      <h1>WONDERFUL GROWTH</h1>
      <div class="subtitle">ä¼æ¥­ã‚¹ãƒ•ã‚£ã‚¢ç›¤ - ç¤¾å†…é™å®š</div>
      <input type="password" id="password-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="off">
      <button onclick="attemptLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div class="login-error" id="login-error"></div>
      <div class="login-hint">â€» ç¤¾å†…ãƒ¡ãƒ³ãƒãƒ¼ç”¨ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼</div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div id="main-content">
    <div id="container">
      <canvas id="canvas"></canvas>
    </div>

    <div id="tooltip"></div>

    <button id="logout-btn" onclick="logout()">ğŸ”“ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

    <div id="gates">
    <h2>WONDERFUL GROWTH</h2>
    <div class="subtitle">ä¼æ¥­ã‚¹ãƒ•ã‚£ã‚¢ç›¤</div>
    <h3>åŸºç›¤ã‚²ãƒ¼ãƒˆé”æˆæ¡ä»¶</h3>
    <ul>
      <li>ç¾é é‡‘ï¼šå›ºå®šè²»4ãƒ¶æœˆåˆ†ä»¥ä¸Š</li>
      <li>ç²—åˆ©ç‡ï¼š40%ä»¥ä¸Š</li>
      <li>ç¨¼åƒç‡ï¼š100%</li>
      <li>æ¡ç”¨ï¼šå¥‘ç´„æ¸ˆã¿Backlogã®ã¿</li>
      <li>ã‚ªãƒ•ã‚£ã‚¹ï¼šè³ƒæ–™ â‰¤ ç²—åˆ©15%</li>
    </ul>
  </div>

  <div id="legend">
    <h2>ãƒãƒ¼ãƒ‰çŠ¶æ…‹</h2>
    <div class="legend-item">
      <div class="legend-dot" style="background: radial-gradient(circle at 30% 30%, #FFF5CC, #FFD700); box-shadow: 0 0 12px #FFD700;"></div>
      <div class="legend-text"><span class="label">å®šç€ (Mastered)</span><br><span class="desc">ç¿’å¾—å®Œäº†ãƒ»å®šç€æ¸ˆã¿</span></div>
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background: radial-gradient(circle at 30% 30%, #66E699, #33E680); box-shadow: 0 0 10px #33E680;"></div>
      <div class="legend-text"><span class="label">è§£æ”¾æ¸ˆ (Unlocked)</span><br><span class="desc">ç¿’å¾—ä¸­ãƒ»å®Ÿæ–½ä¸­</span></div>
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background: radial-gradient(circle at 30% 30%, #FFE066, #FFD700); box-shadow: 0 0 8px #FFD700;"></div>
      <div class="legend-text"><span class="label">è§£æ”¾å¯ (Eligible)</span><br><span class="desc">æ¡ä»¶ã‚¯ãƒªã‚¢ãƒ»è§£æ”¾å¯èƒ½</span></div>
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background: radial-gradient(circle at 30% 30%, #444, #333); border: 1px solid #555;"></div>
      <div class="legend-text"><span class="label">æœªè§£æ”¾ (Locked)</span><br><span class="desc">æ¡ä»¶æœªé”æˆ</span></div>
    </div>

    <h3>å¿…è¦ã‚¹ãƒ•ã‚£ã‚¢</h3>
    <div class="legend-item">
      <div class="legend-sphere" style="background: #3399E6; box-shadow: 0 0 6px #3399E6;"></div>
      <div class="legend-text"><span class="label">äººæ</span> <span class="desc">æ¡ç”¨ãƒ»è‚²æˆ</span></div>
    </div>
    <div class="legend-item">
      <div class="legend-sphere" style="background: #E6B333; box-shadow: 0 0 6px #E6B333;"></div>
      <div class="legend-text"><span class="label">è³‡é‡‘</span> <span class="desc">è²¡å‹™ãƒ»æŠ•è³‡</span></div>
    </div>
    <div class="legend-item">
      <div class="legend-sphere" style="background: #4DCC80; box-shadow: 0 0 6px #4DCC80;"></div>
      <div class="legend-text"><span class="label">å®Ÿç¸¾</span> <span class="desc">æˆåŠŸä½“é¨“</span></div>
    </div>
    <div class="legend-item">
      <div class="legend-sphere" style="background: #9966CC; box-shadow: 0 0 6px #9966CC;"></div>
      <div class="legend-text"><span class="label">æ™‚é–“</span> <span class="desc">ç¶™ç¶šçš„å–çµ„</span></div>
    </div>
    <div class="legend-item">
      <div class="legend-sphere" style="background: #E68033; box-shadow: 0 0 6px #E68033;"></div>
      <div class="legend-text"><span class="label">ä¿¡é ¼</span> <span class="desc">ä¿¡é ¼é–¢ä¿‚</span></div>
    </div>
    <div class="legend-item">
      <div class="legend-sphere" style="background: #66B3E6; box-shadow: 0 0 6px #66B3E6;"></div>
      <div class="legend-text"><span class="label">æŠ€è¡“</span> <span class="desc">æŠ€è¡“åŠ›</span></div>
    </div>
  </div>

  <button id="editor-toggle" onclick="toggleEditor()">ğŸ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>

  <div id="editor-panel">
    <h2>
      ã‚¹ãƒ•ã‚£ã‚¢ç›¤ã‚¨ãƒ‡ã‚£ã‚¿
      <button class="close-btn" onclick="toggleEditor()">Ã—</button>
    </h2>

    <div class="editor-section">
      <h3>ãƒãƒ¼ãƒ‰ä¸€è¦§</h3>
      <div class="node-list" id="node-list"></div>
      <button class="btn btn-secondary" onclick="addNewNode()">+ æ–°è¦ãƒãƒ¼ãƒ‰è¿½åŠ </button>
    </div>

    <div class="editor-section" id="node-editor" style="display: none;">
      <h3>ãƒãƒ¼ãƒ‰ç·¨é›†</h3>
      <div class="form-row">
        <div class="form-group">
          <label>ID</label>
          <input type="text" id="edit-id" placeholder="NODE_ID">
        </div>
        <div class="form-group">
          <label>ãƒªãƒ³ã‚°</label>
          <select id="edit-ring">
            <option value="R30">R30 (3,000ä¸‡)</option>
            <option value="R60">R60 (6,000ä¸‡)</option>
            <option value="R100">R100 (1å„„)</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>ãƒ©ãƒ™ãƒ«ï¼ˆæ”¹è¡Œã§2è¡Œï¼‰</label>
        <input type="text" id="edit-label" placeholder="ãƒ©ãƒ™ãƒ«å">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>çŠ¶æ…‹</label>
          <select id="edit-state">
            <option value="LOCKED">æœªè§£æ”¾ (LOCKED)</option>
            <option value="ELIGIBLE">è§£æ”¾å¯ (ELIGIBLE)</option>
            <option value="UNLOCKED">è§£æ”¾æ¸ˆ (UNLOCKED)</option>
            <option value="MASTERED">å®šç€ (MASTERED)</option>
          </select>
        </div>
        <div class="form-group">
          <label>è§’åº¦ (åº¦)</label>
          <input type="number" id="edit-angle" min="-180" max="180" value="0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>é‡è¦åº¦</label>
          <select id="edit-importance">
            <option value="STANDARD">æ¨™æº–</option>
            <option value="MAJOR">é‡è¦</option>
            <option value="MINOR">å°</option>
          </select>
        </div>
        <div class="form-group">
          <label>å½¢çŠ¶</label>
          <select id="edit-shape">
            <option value="circle">å†† (äººæç³»)</option>
            <option value="hexagon">å…­è§’å½¢ (ãƒ—ãƒ­ã‚»ã‚¹)</option>
            <option value="diamond">è±å½¢ (å“è³ª)</option>
            <option value="octagon">å…«è§’å½¢ (æ–°è¦äº‹æ¥­)</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>èª¬æ˜</label>
        <textarea id="edit-description" placeholder="ã“ã®ãƒãƒ¼ãƒ‰ã®èª¬æ˜"></textarea>
      </div>
      <div class="form-group">
        <label>åŠ¹æœ</label>
        <input type="text" id="edit-effect" placeholder="è§£æ”¾æ™‚ã®åŠ¹æœ">
      </div>
      <div class="form-group">
        <label>å¿…è¦ã‚¹ãƒ•ã‚£ã‚¢</label>
        <div class="sphere-editor" id="sphere-editor"></div>
      </div>
      <div class="form-group">
        <label>æ¥ç¶šå…ƒãƒãƒ¼ãƒ‰</label>
        <select id="edit-parent">
          <option value="">ãªã—ï¼ˆCOREã‹ã‚‰æ¥ç¶šï¼‰</option>
        </select>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="saveNode()">ä¿å­˜</button>
        <button class="btn btn-danger" onclick="deleteNode()">å‰Šé™¤</button>
        <button class="btn btn-secondary" onclick="cancelEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>

    <div id="export-section">
      <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="exportData()">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button class="btn btn-secondary" onclick="importData()">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button class="btn btn-secondary" onclick="downloadImage()">ğŸ–¼ï¸ ç”»åƒä¿å­˜</button>
      </div>
    </div>
  </div>
  </div> <!-- main-content çµ‚äº† -->

  <script>
    // ============================================================
    // èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 
    // ============================================================
    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šï¼ˆå¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
    const ACCESS_PASSWORD = 'wg2024';
    const AUTH_KEY = 'wg_sphere_auth';
    const AUTH_EXPIRY_DAYS = 7; // ãƒ­ã‚°ã‚¤ãƒ³æœ‰åŠ¹æœŸé™ï¼ˆæ—¥æ•°ï¼‰

    function checkAuth() {
      const authData = localStorage.getItem(AUTH_KEY);
      if (!authData) return false;

      try {
        const { hash, expiry } = JSON.parse(authData);
        if (Date.now() > expiry) {
          localStorage.removeItem(AUTH_KEY);
          return false;
        }
        return hash === simpleHash(ACCESS_PASSWORD);
      } catch {
        return false;
      }
    }

    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return hash.toString(36);
    }

    function attemptLogin() {
      const input = document.getElementById('password-input');
      const error = document.getElementById('login-error');

      if (input.value === ACCESS_PASSWORD) {
        const authData = {
          hash: simpleHash(ACCESS_PASSWORD),
          expiry: Date.now() + (AUTH_EXPIRY_DAYS * 24 * 60 * 60 * 1000)
        };
        localStorage.setItem(AUTH_KEY, JSON.stringify(authData));
        showMainContent();
      } else {
        error.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
        input.value = '';
        input.focus();
      }
    }

    function logout() {
      if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.removeItem(AUTH_KEY);
        location.reload();
      }
    }

    function showMainContent() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('main-content').classList.add('visible');
      initApp();
    }

    // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
    document.getElementById('password-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') attemptLogin();
    });

    // åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯
    if (checkAuth()) {
      showMainContent();
    } else {
      document.getElementById('password-input').focus();
    }

    // ============================================================
    // è¨­å®šï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
    // ============================================================
    let CONFIG = {
      width: 1920,
      height: 1080,

      rings: [
        { id: "R30", label: "å¹´å•† 3,000ä¸‡", radius: 180, glowIntensity: 1.0 },
        { id: "R60", label: "å¹´å•† 6,000ä¸‡", radius: 300, glowIntensity: 0.7 },
        { id: "R100", label: "å¹´å•† 1å„„", radius: 420, glowIntensity: 0.5 },
      ],

      sphereTypes: {
        "äººæ": { color: "#3399E6", desc: "æ¡ç”¨ãƒ»è‚²æˆãƒªã‚½ãƒ¼ã‚¹" },
        "è³‡é‡‘": { color: "#E6B333", desc: "è²¡å‹™ãƒ»æŠ•è³‡ãƒªã‚½ãƒ¼ã‚¹" },
        "å®Ÿç¸¾": { color: "#4DCC80", desc: "æˆåŠŸä½“é¨“ãƒ»ãƒã‚¦ãƒã‚¦" },
        "æ™‚é–“": { color: "#9966CC", desc: "ç¶™ç¶šçš„ãªå–ã‚Šçµ„ã¿" },
        "ä¿¡é ¼": { color: "#E68033", desc: "ç¤¾å†…å¤–ã®ä¿¡é ¼é–¢ä¿‚" },
        "æŠ€è¡“": { color: "#66B3E6", desc: "æŠ€è¡“åŠ›ãƒ»å°‚é–€æ€§" },
      },

      nodes: [
        // CORE
        {
          id: "CORE", label: "WG\nCORE", ring: "CORE", angleDeg: 0, state: "MASTERED",
          importance: "MAJOR", shape: "octagon", sizeMultiplier: 1.4,
          description: "ä¼æ¥­ã®æ ¸å¿ƒãƒ»å…¨ã¦ã®èµ·ç‚¹",
          effect: "å…¨ãƒãƒ¼ãƒ‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è§£æ”¾",
          requirements: []
        },
        // R30 Ring
        {
          id: "HIRE_3", label: "æ¡ç”¨\nã€œ3å", ring: "R30", angleDeg: -45, state: "ELIGIBLE",
          importance: "STANDARD", shape: "circle",
          description: "æœ€åˆã®æ­£ç¤¾å“¡æ¡ç”¨",
          effect: "ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£+30%",
          requirements: [{ type: "è³‡é‡‘", count: 2 }, { type: "å®Ÿç¸¾", count: 1 }]
        },
        {
          id: "OFFICE_15", label: "ã‚ªãƒ•ã‚£ã‚¹\nè³ƒæ–™â‰¤15%", ring: "R30", angleDeg: 15, state: "ELIGIBLE",
          importance: "STANDARD", shape: "diamond",
          description: "é©æ­£ãªã‚ªãƒ•ã‚£ã‚¹ã‚³ã‚¹ãƒˆ",
          effect: "å›ºå®šè²»æœ€é©åŒ–",
          requirements: [{ type: "è³‡é‡‘", count: 1 }]
        },
        {
          id: "PRODUCTIZE", label: "å‹åŒ–\nç ”ä¿®å•†å“", ring: "R30", angleDeg: 75, state: "ELIGIBLE",
          importance: "MAJOR", shape: "hexagon", sizeMultiplier: 1.15,
          description: "ã‚µãƒ¼ãƒ“ã‚¹ã®æ¨™æº–åŒ–ãƒ»å•†å“åŒ–",
          effect: "å†ç¾æ€§+50%, ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ç¢ºä¿",
          requirements: [{ type: "æŠ€è¡“", count: 2 }, { type: "æ™‚é–“", count: 1 }]
        },
        {
          id: "BACKOFFICE", label: "ãƒãƒƒã‚¯\nã‚ªãƒ•ã‚£ã‚¹", ring: "R30", angleDeg: 150, state: "ELIGIBLE",
          importance: "STANDARD", shape: "circle",
          description: "çµŒç†ãƒ»ç·å‹™ã®åŸºç›¤æ•´å‚™",
          effect: "ç®¡ç†åŠ¹ç‡+20%",
          requirements: [{ type: "è³‡é‡‘", count: 1 }, { type: "äººæ", count: 1 }]
        },
        // R60 Ring
        {
          id: "WELFARE", label: "ç¦åˆ©åšç”Ÿ\nå°å…¥", ring: "R60", angleDeg: -60, state: "LOCKED",
          importance: "STANDARD", shape: "circle",
          description: "ç¤¾å“¡ã®æº€è¶³åº¦å‘ä¸Šæ–½ç­–",
          effect: "å®šç€ç‡+15%",
          requirements: [{ type: "è³‡é‡‘", count: 2 }, { type: "ä¿¡é ¼", count: 1 }]
        },
        {
          id: "HIRE_MORE", label: "æ¡ç”¨\nè¿½åŠ ", ring: "R60", angleDeg: -15, state: "LOCKED",
          importance: "MAJOR", shape: "circle", sizeMultiplier: 1.15,
          description: "ã•ã‚‰ãªã‚‹äººæç¢ºä¿",
          effect: "ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£+50%",
          requirements: [{ type: "è³‡é‡‘", count: 3 }, { type: "äººæ", count: 1 }, { type: "å®Ÿç¸¾", count: 2 }]
        },
        {
          id: "SEC_PREP", label: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£\nèªè¨¼æº–å‚™", ring: "R60", angleDeg: 45, state: "LOCKED",
          importance: "STANDARD", shape: "diamond",
          description: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èªè¨¼ã®æº–å‚™æ®µéš",
          effect: "å¤§ä¼æ¥­æ¡ˆä»¶å¯¾å¿œå¯èƒ½",
          requirements: [{ type: "æŠ€è¡“", count: 2 }, { type: "æ™‚é–“", count: 2 }]
        },
        {
          id: "SALES_PROCESS", label: "å–¶æ¥­\nãƒ—ãƒ­ã‚»ã‚¹", ring: "R60", angleDeg: 115, state: "LOCKED",
          importance: "MAJOR", shape: "hexagon", sizeMultiplier: 1.15,
          description: "å–¶æ¥­æ´»å‹•ã®ä½“ç³»åŒ–",
          effect: "å—æ³¨åŠ¹ç‡+40%",
          requirements: [{ type: "å®Ÿç¸¾", count: 2 }, { type: "æŠ€è¡“", count: 1 }]
        },
        // R100 Ring
        {
          id: "NEW_BIZ", label: "æ–°è¦äº‹æ¥­\nÃ—1", ring: "R100", angleDeg: -30, state: "LOCKED",
          importance: "MAJOR", shape: "octagon", sizeMultiplier: 1.2,
          description: "æ–°ãŸãªäº‹æ¥­é ˜åŸŸã¸ã®é€²å‡º",
          effect: "åç›Šæºã®å¤šè§’åŒ–",
          requirements: [{ type: "è³‡é‡‘", count: 5 }, { type: "äººæ", count: 2 }, { type: "å®Ÿç¸¾", count: 3 }]
        },
        {
          id: "FUNCTION_SPLIT", label: "å°‚ä»»æ©Ÿèƒ½\nåˆ†é›¢", ring: "R100", angleDeg: 30, state: "LOCKED",
          importance: "STANDARD", shape: "circle",
          description: "æ©Ÿèƒ½åˆ¥ã®å°‚ä»»ä½“åˆ¶æ§‹ç¯‰",
          effect: "å°‚é–€æ€§æ·±åŒ–",
          requirements: [{ type: "äººæ", count: 3 }, { type: "è³‡é‡‘", count: 2 }]
        },
        {
          id: "SEC_GET", label: "èªè¨¼\næœ¬å–å¾—", ring: "R100", angleDeg: 90, state: "LOCKED",
          importance: "MAJOR", shape: "diamond", sizeMultiplier: 1.15,
          description: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£èªè¨¼ã®æ­£å¼å–å¾—",
          effect: "ä¿¡é ¼æ€§è¨¼æ˜, å¤§å‹æ¡ˆä»¶ç²å¾—",
          requirements: [{ type: "æŠ€è¡“", count: 3 }, { type: "æ™‚é–“", count: 3 }, { type: "è³‡é‡‘", count: 2 }]
        },
        {
          id: "LEAD_DEV", label: "ãƒªãƒ¼ãƒ‰\nè‚²æˆ", ring: "R100", angleDeg: 160, state: "LOCKED",
          importance: "MAJOR", shape: "circle", sizeMultiplier: 1.15,
          description: "æ¬¡ä¸–ä»£ãƒªãƒ¼ãƒ€ãƒ¼ã®è‚²æˆ",
          effect: "çµ„ç¹”ã®æŒç¶šå¯èƒ½æ€§ç¢ºä¿",
          requirements: [{ type: "äººæ", count: 2 }, { type: "æ™‚é–“", count: 3 }, { type: "ä¿¡é ¼", count: 2 }]
        },
      ],

      edges: [
        { from: "CORE", to: "HIRE_3", type: "MAIN" },
        { from: "CORE", to: "OFFICE_15", type: "MAIN" },
        { from: "CORE", to: "PRODUCTIZE", type: "MAIN" },
        { from: "CORE", to: "BACKOFFICE", type: "MAIN" },
        { from: "HIRE_3", to: "WELFARE", type: "OPTIONAL" },
        { from: "HIRE_3", to: "HIRE_MORE", type: "MAIN" },
        { from: "HIRE_MORE", to: "FUNCTION_SPLIT", type: "MAIN" },
        { from: "FUNCTION_SPLIT", to: "LEAD_DEV", type: "MAIN" },
        { from: "PRODUCTIZE", to: "SALES_PROCESS", type: "MAIN" },
        { from: "SALES_PROCESS", to: "NEW_BIZ", type: "MAIN" },
        { from: "SALES_PROCESS", to: "SEC_PREP", type: "OPTIONAL" },
        { from: "SEC_PREP", to: "SEC_GET", type: "MAIN" },
        { from: "BACKOFFICE", to: "SEC_PREP", type: "CROSS_DOMAIN" },
      ],

      nodeSizes: {
        MAJOR: 55,
        STANDARD: 45,
        MINOR: 35,
      }
    };

    // ============================================================
    // Canvas å¤‰æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
    // ============================================================
    let canvas, ctx, tooltip;
    let scale = 1;
    let cx, cy;
    let nodePositions = [];
    let selectedNodeId = null;
    let isEditorOpen = false;

    // ============================================================
    // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
    // ============================================================
    function initApp() {
      canvas = document.getElementById('canvas');
      ctx = canvas.getContext('2d');
      tooltip = document.getElementById('tooltip');

      window.addEventListener('resize', resize);
      resize();

      // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      canvas.addEventListener('mousemove', handleMouseMove);
      canvas.addEventListener('mouseleave', hideTooltip);
      canvas.addEventListener('click', handleClick);
    }

    function handleMouseMove(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      let hoveredNode = null;
      for (const { node, x: nx, y: ny, size } of nodePositions) {
        const dist = Math.sqrt((x - nx) ** 2 + (y - ny) ** 2);
        if (dist < size * 1.2) {
          hoveredNode = node;
          break;
        }
      }

      if (hoveredNode) {
        showTooltip(hoveredNode, e.clientX, e.clientY);
        canvas.style.cursor = 'pointer';
      } else {
        hideTooltip();
        canvas.style.cursor = 'default';
      }
    }

    function handleClick(e) {
      if (!isEditorOpen) return;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      for (const { node, x: nx, y: ny, size } of nodePositions) {
        const dist = Math.sqrt((x - nx) ** 2 + (y - ny) ** 2);
        if (dist < size * 1.2) {
          selectNode(node.id);
          return;
        }
      }
    }

    // ============================================================
    // Canvas æç”»
    // ============================================================
    function resize() {
      const dpr = window.devicePixelRatio || 1;
      const w = window.innerWidth;
      const h = window.innerHeight;

      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';

      ctx.scale(dpr, dpr);

      scale = Math.min(w / CONFIG.width, h / CONFIG.height) * 0.9;
      cx = w / 2;
      cy = h / 2;

      draw();
    }

    // ============================================================
    // æç”»é–¢æ•°
    // ============================================================
    function draw() {
      const w = canvas.width / (window.devicePixelRatio || 1);
      const h = canvas.height / (window.devicePixelRatio || 1);

      ctx.fillStyle = '#050812';
      ctx.fillRect(0, 0, w, h);

      drawStarField(w, h);
      drawCenterGlow();
      drawRings();
      drawEdges();

      nodePositions = [];
      CONFIG.nodes.forEach(node => {
        const pos = drawNode(node);
        nodePositions.push({ node, ...pos });
      });
    }

    function drawStarField(w, h) {
      let seed = 54321;
      const random = () => {
        seed = (seed * 1103515245 + 12345) & 0x7fffffff;
        return seed / 0x7fffffff;
      };

      const layers = [
        { count: 100, sizeRange: [0.5, 1.5], opacityRange: [0.2, 0.4] },
        { count: 50, sizeRange: [1, 2], opacityRange: [0.3, 0.6] },
        { count: 20, sizeRange: [2, 3], opacityRange: [0.5, 0.8] },
      ];

      layers.forEach(layer => {
        for (let i = 0; i < layer.count; i++) {
          const x = random() * w;
          const y = random() * h;
          const dist = Math.sqrt((x - cx) ** 2 + (y - cy) ** 2);
          if (dist < 150 * scale) continue;

          const size = layer.sizeRange[0] + random() * (layer.sizeRange[1] - layer.sizeRange[0]);
          const opacity = layer.opacityRange[0] + random() * (layer.opacityRange[1] - layer.opacityRange[0]);

          ctx.beginPath();
          ctx.arc(x, y, size, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
          ctx.fill();

          if (size > 2) {
            ctx.beginPath();
            ctx.arc(x, y, size * 2, 0, Math.PI * 2);
            const gradient = ctx.createRadialGradient(x, y, 0, x, y, size * 2);
            gradient.addColorStop(0, `rgba(180, 200, 255, ${opacity * 0.3})`);
            gradient.addColorStop(1, 'rgba(180, 200, 255, 0)');
            ctx.fillStyle = gradient;
            ctx.fill();
          }
        }
      });
    }

    function drawCenterGlow() {
      const r = 500 * scale;
      const gradient = ctx.createRadialGradient(cx, cy, 0, cx, cy, r);
      gradient.addColorStop(0, 'rgba(20, 36, 66, 0.6)');
      gradient.addColorStop(0.5, 'rgba(20, 36, 66, 0.3)');
      gradient.addColorStop(1, 'rgba(20, 36, 66, 0)');

      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI * 2);
      ctx.fillStyle = gradient;
      ctx.fill();
    }

    function drawRings() {
      CONFIG.rings.forEach(ring => {
        const r = ring.radius * scale;

        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(74, 122, 184, ${0.15 * ring.glowIntensity})`;
        ctx.lineWidth = 6;
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(74, 122, 184, ${0.4 + 0.3 * ring.glowIntensity})`;
        ctx.lineWidth = 1.5;
        ctx.stroke();

        ctx.font = '12px "Segoe UI", sans-serif';
        ctx.fillStyle = `rgba(180, 200, 220, ${0.5 + 0.3 * ring.glowIntensity})`;
        ctx.textAlign = 'left';
        ctx.fillText(ring.label, cx + r + 15, cy + 4);
      });
    }

    function getNodePosition(node) {
      if (node.ring === "CORE") {
        return { x: cx, y: cy };
      }
      const ring = CONFIG.rings.find(r => r.id === node.ring);
      const r = ring ? ring.radius * scale : 0;
      const rad = (node.angleDeg * Math.PI) / 180;
      return {
        x: cx + r * Math.cos(rad),
        y: cy + r * Math.sin(rad)
      };
    }

    function drawEdges() {
      const nodeMap = new Map();
      CONFIG.nodes.forEach(n => nodeMap.set(n.id, getNodePosition(n)));

      CONFIG.edges.forEach(edge => {
        const a = nodeMap.get(edge.from);
        const b = nodeMap.get(edge.to);
        if (!a || !b) return;

        const isMain = edge.type === "MAIN";
        const isOptional = edge.type === "OPTIONAL";
        const isCross = edge.type === "CROSS_DOMAIN";

        ctx.beginPath();
        ctx.moveTo(a.x, a.y);
        ctx.lineTo(b.x, b.y);
        ctx.strokeStyle = `rgba(58, 96, 144, ${isMain ? 0.3 : 0.15})`;
        ctx.lineWidth = isMain ? 8 : 5;
        ctx.lineCap = 'round';
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(a.x, a.y);
        ctx.lineTo(b.x, b.y);
        ctx.strokeStyle = isCross ? 'rgba(184, 138, 8, 0.6)' : `rgba(74, 122, 184, ${isMain ? 0.8 : 0.5})`;
        ctx.lineWidth = isMain ? 3 : 1.5;
        if (isOptional) {
          ctx.setLineDash([6, 4]);
        } else {
          ctx.setLineDash([]);
        }
        ctx.stroke();
        ctx.setLineDash([]);
      });
    }

    function drawNode(node) {
      const pos = getNodePosition(node);
      const baseSize = CONFIG.nodeSizes[node.importance];
      const size = baseSize * (node.sizeMultiplier || 1) * scale;

      let fillColor, strokeColor, glowColor;
      switch (node.state) {
        case "MASTERED":
          fillColor = '#4A3D1A';
          strokeColor = '#FFE680';
          glowColor = 'rgba(255, 215, 0, 0.6)';
          break;
        case "UNLOCKED":
          fillColor = '#1A3D2A';
          strokeColor = '#33E680';
          glowColor = 'rgba(51, 230, 128, 0.5)';
          break;
        case "ELIGIBLE":
          fillColor = '#3D3520';
          strokeColor = '#FFD700';
          glowColor = 'rgba(255, 215, 0, 0.4)';
          break;
        default:
          fillColor = '#252830';
          strokeColor = '#4A4E58';
          glowColor = null;
          break;
      }

      // é¸æŠãƒã‚¤ãƒ©ã‚¤ãƒˆ
      if (node.id === selectedNodeId) {
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, size * 1.6, 0, Math.PI * 2);
        ctx.strokeStyle = '#FFD700';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.stroke();
        ctx.setLineDash([]);
      }

      if (glowColor) {
        const glowSize = size * 1.4;
        const gradient = ctx.createRadialGradient(pos.x, pos.y, size * 0.5, pos.x, pos.y, glowSize);
        gradient.addColorStop(0, glowColor);
        gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, glowSize, 0, Math.PI * 2);
        ctx.fillStyle = gradient;
        ctx.fill();
      }

      ctx.beginPath();
      if (node.shape === "circle") {
        ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
      } else if (node.shape === "hexagon") {
        drawPolygon(pos.x, pos.y, size, 6, Math.PI / 6);
      } else if (node.shape === "diamond") {
        drawPolygon(pos.x, pos.y, size, 4, 0);
      } else if (node.shape === "octagon") {
        drawPolygon(pos.x, pos.y, size, 8, Math.PI / 8);
      }

      const fillGradient = ctx.createRadialGradient(
        pos.x - size * 0.3, pos.y - size * 0.3, 0,
        pos.x, pos.y, size
      );
      fillGradient.addColorStop(0, lightenColor(fillColor, 0.3));
      fillGradient.addColorStop(1, fillColor);
      ctx.fillStyle = fillGradient;
      ctx.fill();

      ctx.strokeStyle = strokeColor;
      ctx.lineWidth = node.state === "MASTERED" ? 4 : 3;
      ctx.stroke();

      ctx.beginPath();
      ctx.ellipse(pos.x - size * 0.2, pos.y - size * 0.3, size * 0.35, size * 0.2, -0.3, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255, 255, 255, ${node.state === "LOCKED" ? 0.05 : 0.15})`;
      ctx.fill();

      ctx.beginPath();
      if (node.shape === "circle") {
        ctx.arc(pos.x, pos.y, size * 0.75, 0, Math.PI * 2);
      } else if (node.shape === "hexagon") {
        drawPolygon(pos.x, pos.y, size * 0.75, 6, Math.PI / 6);
      } else if (node.shape === "diamond") {
        drawPolygon(pos.x, pos.y, size * 0.75, 4, 0);
      } else if (node.shape === "octagon") {
        drawPolygon(pos.x, pos.y, size * 0.75, 8, Math.PI / 8);
      }
      ctx.strokeStyle = `rgba(${hexToRgb(strokeColor)}, 0.5)`;
      ctx.lineWidth = 1;
      ctx.stroke();

      ctx.font = `bold ${11 * scale}px "Segoe UI", "Hiragino Sans", sans-serif`;
      ctx.fillStyle = node.state === "LOCKED" ? '#666' : '#fff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      const lines = node.label.split('\n');
      const lineHeight = 13 * scale;
      const startY = pos.y - ((lines.length - 1) * lineHeight) / 2;
      lines.forEach((line, i) => {
        ctx.fillText(line, pos.x, startY + i * lineHeight);
      });

      if (node.state === "LOCKED") {
        ctx.font = `${10 * scale}px sans-serif`;
        ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
        ctx.fillText('ğŸ”’', pos.x + size * 0.6, pos.y - size * 0.6);
      }

      if (node.requirements && node.requirements.length > 0 && node.id !== "CORE") {
        drawNodeRequirements(node, pos, size);
      }

      return { x: pos.x, y: pos.y, size };
    }

    function drawNodeRequirements(node, pos, size) {
      const dx = pos.x - cx;
      const dy = pos.y - cy;
      const dist = Math.sqrt(dx * dx + dy * dy);
      const dirX = dist > 0 ? dx / dist : 0;
      const dirY = dist > 0 ? dy / dist : 1;

      const offset = size + 15 * scale;
      const labelX = pos.x + dirX * offset;
      const labelY = pos.y + dirY * offset;

      const sphereSize = 6 * scale;
      const spacing = 14 * scale;
      const totalWidth = node.requirements.length * spacing;

      let startX = labelX - totalWidth / 2;
      if (dirX > 0.5) startX = labelX;
      else if (dirX < -0.5) startX = labelX - totalWidth;

      node.requirements.forEach((req, i) => {
        const sphereX = startX + i * spacing + sphereSize / 2;
        const sphereY = labelY;
        const color = CONFIG.sphereTypes[req.type]?.color || '#888';

        ctx.beginPath();
        ctx.arc(sphereX, sphereY, sphereSize * 1.5, 0, Math.PI * 2);
        const gradient = ctx.createRadialGradient(sphereX, sphereY, 0, sphereX, sphereY, sphereSize * 1.5);
        gradient.addColorStop(0, `${color}44`);
        gradient.addColorStop(1, 'transparent');
        ctx.fillStyle = gradient;
        ctx.fill();

        ctx.beginPath();
        ctx.arc(sphereX, sphereY, sphereSize, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();

        ctx.font = `bold ${8 * scale}px sans-serif`;
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(req.count.toString(), sphereX, sphereY);
      });
    }

    function drawPolygon(x, y, radius, sides, rotation = 0) {
      ctx.moveTo(
        x + radius * Math.cos(rotation),
        y + radius * Math.sin(rotation)
      );
      for (let i = 1; i <= sides; i++) {
        const angle = rotation + (i * 2 * Math.PI) / sides;
        ctx.lineTo(
          x + radius * Math.cos(angle),
          y + radius * Math.sin(angle)
        );
      }
      ctx.closePath();
    }

    function lightenColor(hex, amount) {
      const rgb = hexToRgb(hex);
      const [r, g, b] = rgb.split(',').map(v => parseInt(v.trim()));
      return `rgb(${Math.min(255, r + amount * 255)}, ${Math.min(255, g + amount * 255)}, ${Math.min(255, b + amount * 255)})`;
    }

    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result
        ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}`
        : '0, 0, 0';
    }

    // ============================================================
    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
    // ============================================================
    function showTooltip(node, x, y) {
      let html = `<h3>${node.label.replace('\n', ' ')}</h3>`;
      html += `<span class="state ${node.state}">${getStateName(node.state)}</span>`;
      html += `<div class="description">${node.description}</div>`;

      if (node.requirements && node.requirements.length > 0) {
        html += `<div class="requirements"><h4>å¿…è¦ã‚¹ãƒ•ã‚£ã‚¢</h4>`;
        node.requirements.forEach(req => {
          const color = CONFIG.sphereTypes[req.type]?.color || '#888';
          html += `<span class="sphere-item" style="background: ${color}33; color: ${color}">${req.type} Ã—${req.count}</span>`;
        });
        html += `</div>`;
      }

      if (node.effect) {
        html += `<div class="effect">â†’ ${node.effect}</div>`;
      }

      tooltip.innerHTML = html;
      tooltip.style.display = 'block';

      const tooltipRect = tooltip.getBoundingClientRect();
      let left = x + 15;
      let top = y + 15;

      if (left + tooltipRect.width > window.innerWidth) {
        left = x - tooltipRect.width - 15;
      }
      if (top + tooltipRect.height > window.innerHeight) {
        top = y - tooltipRect.height - 15;
      }

      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';
    }

    function hideTooltip() {
      tooltip.style.display = 'none';
    }

    function getStateName(state) {
      switch (state) {
        case "MASTERED": return "å®šç€";
        case "UNLOCKED": return "è§£æ”¾æ¸ˆ";
        case "ELIGIBLE": return "è§£æ”¾å¯";
        default: return "æœªè§£æ”¾";
      }
    }

    // ============================================================
    // ã‚¨ãƒ‡ã‚£ã‚¿
    // ============================================================
    function toggleEditor() {
      isEditorOpen = !isEditorOpen;
      document.getElementById('editor-panel').classList.toggle('open', isEditorOpen);
      document.getElementById('editor-toggle').textContent = isEditorOpen ? 'âœ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰' : 'ğŸ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';

      if (isEditorOpen) {
        updateNodeList();
      }
    }

    function updateNodeList() {
      const list = document.getElementById('node-list');
      list.innerHTML = '';

      CONFIG.nodes.filter(n => n.id !== 'CORE').forEach(node => {
        const item = document.createElement('div');
        item.className = 'node-list-item' + (node.id === selectedNodeId ? ' selected' : '');
        item.onclick = () => selectNode(node.id);

        const stateColors = {
          MASTERED: '#FFD700',
          UNLOCKED: '#33E680',
          ELIGIBLE: '#FFD700',
          LOCKED: '#4A4E58'
        };

        item.innerHTML = `
          <div class="node-dot" style="background: ${stateColors[node.state]}"></div>
          <span class="node-name">${node.label.replace('\n', ' ')}</span>
          <span class="node-state state ${node.state}">${getStateName(node.state)}</span>
        `;
        list.appendChild(item);
      });

      // è¦ªãƒãƒ¼ãƒ‰é¸æŠè‚¢ã‚’æ›´æ–°
      const parentSelect = document.getElementById('edit-parent');
      parentSelect.innerHTML = '<option value="CORE">COREï¼ˆä¸­å¤®ï¼‰ã‹ã‚‰æ¥ç¶š</option>';
      CONFIG.nodes.filter(n => n.id !== 'CORE').forEach(node => {
        parentSelect.innerHTML += `<option value="${node.id}">${node.label.replace('\n', ' ')}</option>`;
      });
    }

    function selectNode(id) {
      selectedNodeId = id;
      const node = CONFIG.nodes.find(n => n.id === id);
      if (!node) return;

      document.getElementById('node-editor').style.display = 'block';

      document.getElementById('edit-id').value = node.id;
      document.getElementById('edit-label').value = node.label.replace('\n', ' ');
      document.getElementById('edit-ring').value = node.ring;
      document.getElementById('edit-state').value = node.state;
      document.getElementById('edit-angle').value = node.angleDeg;
      document.getElementById('edit-importance').value = node.importance;
      document.getElementById('edit-shape').value = node.shape;
      document.getElementById('edit-description').value = node.description || '';
      document.getElementById('edit-effect').value = node.effect || '';

      // ã‚¹ãƒ•ã‚£ã‚¢ã‚¨ãƒ‡ã‚£ã‚¿
      const sphereEditor = document.getElementById('sphere-editor');
      sphereEditor.innerHTML = '';
      Object.entries(CONFIG.sphereTypes).forEach(([type, info]) => {
        const req = node.requirements?.find(r => r.type === type);
        const count = req ? req.count : 0;
        sphereEditor.innerHTML += `
          <div class="sphere-tag" style="background: ${info.color}33; color: ${info.color}">
            ${type}
            <input type="number" min="0" max="10" value="${count}" data-type="${type}">
          </div>
        `;
      });

      // è¦ªãƒãƒ¼ãƒ‰
      const edge = CONFIG.edges.find(e => e.to === id);
      document.getElementById('edit-parent').value = edge ? edge.from : 'CORE';

      updateNodeList();
      draw();
    }

    function addNewNode() {
      const newId = 'NODE_' + Date.now();
      const newNode = {
        id: newId,
        label: 'æ–°è¦\nãƒãƒ¼ãƒ‰',
        ring: 'R30',
        angleDeg: Math.floor(Math.random() * 360) - 180,
        state: 'LOCKED',
        importance: 'STANDARD',
        shape: 'circle',
        description: 'æ–°ã—ã„ãƒãƒ¼ãƒ‰ã®èª¬æ˜',
        effect: 'åŠ¹æœã‚’å…¥åŠ›',
        requirements: []
      };

      CONFIG.nodes.push(newNode);
      CONFIG.edges.push({ from: 'CORE', to: newId, type: 'MAIN' });

      selectNode(newId);
      draw();
    }

    function saveNode() {
      const id = document.getElementById('edit-id').value;
      const node = CONFIG.nodes.find(n => n.id === selectedNodeId);
      if (!node) return;

      // IDãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€ã‚¨ãƒƒã‚¸ã‚‚æ›´æ–°
      if (id !== selectedNodeId) {
        CONFIG.edges.forEach(e => {
          if (e.from === selectedNodeId) e.from = id;
          if (e.to === selectedNodeId) e.to = id;
        });
        node.id = id;
        selectedNodeId = id;
      }

      node.label = document.getElementById('edit-label').value.replace(' ', '\n');
      node.ring = document.getElementById('edit-ring').value;
      node.state = document.getElementById('edit-state').value;
      node.angleDeg = parseInt(document.getElementById('edit-angle').value);
      node.importance = document.getElementById('edit-importance').value;
      node.shape = document.getElementById('edit-shape').value;
      node.description = document.getElementById('edit-description').value;
      node.effect = document.getElementById('edit-effect').value;

      // ã‚¹ãƒ•ã‚£ã‚¢è¦ä»¶
      node.requirements = [];
      document.querySelectorAll('#sphere-editor input').forEach(input => {
        const count = parseInt(input.value);
        if (count > 0) {
          node.requirements.push({ type: input.dataset.type, count });
        }
      });

      // è¦ªãƒãƒ¼ãƒ‰ï¼ˆã‚¨ãƒƒã‚¸ï¼‰
      const parentId = document.getElementById('edit-parent').value;
      const existingEdgeIndex = CONFIG.edges.findIndex(e => e.to === id);
      if (existingEdgeIndex >= 0) {
        CONFIG.edges[existingEdgeIndex].from = parentId;
      } else {
        CONFIG.edges.push({ from: parentId, to: id, type: 'MAIN' });
      }

      updateNodeList();
      draw();
      alert('ä¿å­˜ã—ã¾ã—ãŸ');
    }

    function deleteNode() {
      if (!selectedNodeId || selectedNodeId === 'CORE') {
        alert('COREã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
        return;
      }

      if (!confirm('ã“ã®ãƒãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      CONFIG.nodes = CONFIG.nodes.filter(n => n.id !== selectedNodeId);
      CONFIG.edges = CONFIG.edges.filter(e => e.from !== selectedNodeId && e.to !== selectedNodeId);

      selectedNodeId = null;
      document.getElementById('node-editor').style.display = 'none';
      updateNodeList();
      draw();
    }

    function cancelEdit() {
      selectedNodeId = null;
      document.getElementById('node-editor').style.display = 'none';
      updateNodeList();
      draw();
    }

    // ============================================================
    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    // ============================================================
    function exportData() {
      const data = {
        nodes: CONFIG.nodes,
        edges: CONFIG.edges
      };
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sphere-grid-data.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (data.nodes && data.edges) {
              CONFIG.nodes = data.nodes;
              CONFIG.edges = data.edges;
              updateNodeList();
              draw();
              alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
            }
          } catch (err) {
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function downloadImage() {
      const link = document.createElement('a');
      link.download = 'sphere-grid.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }
  </script>
</body>
</html>
