<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WG Sphere Grid - ä¼æ¥­ã‚¹ãƒ•ã‚£ã‚¢ç›¤</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #03060f;
      font-family: 'Outfit', 'Hiragino Sans', sans-serif;
      overflow: hidden;
      color: #fff;
    }

    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    #login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #050812 0%, #0A1628 50%, #051020 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    #login-screen.hidden {
      display: none;
    }

    .login-box {
      background: rgba(10, 22, 40, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(74, 122, 184, 0.3);
      border-radius: 24px;
      padding: 48px 60px;
      text-align: center;
      box-shadow: 0 40px 100px rgba(0, 0, 0, 0.6), 0 0 40px rgba(74, 122, 184, 0.1);
      animation: fadeIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .login-logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: radial-gradient(circle at 30% 30%, #FFE066, #B88A08);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 32px;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
    }

    .login-box h1 {
      color: #FFD700;
      font-size: 24px;
      letter-spacing: 3px;
      margin-bottom: 8px;
    }

    .login-box .subtitle {
      color: #889;
      font-size: 14px;
      margin-bottom: 30px;
    }

    .login-box input[type="password"] {
      width: 100%;
      padding: 14px 20px;
      background: rgba(20, 40, 60, 0.8);
      border: 1px solid rgba(74, 122, 184, 0.3);
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      text-align: center;
      letter-spacing: 4px;
      margin-bottom: 16px;
    }

    .login-box input[type="password"]:focus {
      outline: none;
      border-color: #FFD700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
    }

    .login-box input[type="password"]::placeholder {
      letter-spacing: 0;
      color: #556;
    }

    .login-box button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #B88A08, #FFD700);
      border: none;
      border-radius: 8px;
      color: #000;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }

    .login-box button:hover {
      background: linear-gradient(135deg, #FFD700, #FFE44D);
      box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
    }

    .login-error {
      color: #E64D66;
      font-size: 13px;
      margin-top: 12px;
      min-height: 20px;
    }

    .login-hint {
      color: #556;
      font-size: 11px;
      margin-top: 20px;
    }

    #logout-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(100, 100, 120, 0.3);
      border: 1px solid rgba(100, 100, 120, 0.5);
      color: #889;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      z-index: 100;
    }

    #logout-btn:hover {
      background: rgba(230, 77, 102, 0.3);
      border-color: rgba(230, 77, 102, 0.5);
      color: #E64D66;
    }

    #main-content {
      display: none;
    }

    #main-content.visible {
      display: block;
    }

    #container {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    canvas {
      display: block;
      cursor: default;
    }

    canvas.dragging {
      cursor: grabbing;
    }

    canvas.can-drag {
      cursor: grab;
    }

    #tooltip {
      position: absolute;
      display: none;
      background: rgba(10, 16, 36, 0.95);
      border: 1px solid rgba(74, 122, 184, 0.5);
      border-radius: 8px;
      padding: 12px 16px;
      color: #fff;
      font-size: 12px;
      max-width: 280px;
      pointer-events: none;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    #tooltip h3 {
      color: #FFD700;
      font-size: 14px;
      margin-bottom: 8px;
    }

    #tooltip .state {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      margin-bottom: 8px;
    }

    #tooltip .state.MASTERED {
      background: rgba(255, 215, 0, 0.3);
      color: #FFD700;
    }

    #tooltip .state.UNLOCKED {
      background: rgba(51, 230, 128, 0.3);
      color: #33E680;
    }

    #tooltip .state.ELIGIBLE {
      background: rgba(255, 215, 0, 0.2);
      color: #FFD700;
    }

    #tooltip .state.LOCKED {
      background: rgba(100, 100, 120, 0.3);
      color: #888;
    }

    #tooltip .description {
      color: #aab;
      margin-bottom: 8px;
    }

    #tooltip .requirements {
      margin-top: 8px;
    }

    #tooltip .requirements h4 {
      color: #B88A08;
      font-size: 11px;
      margin-bottom: 4px;
    }

    #tooltip .sphere-item {
      display: inline-block;
      margin: 2px 4px 2px 0;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
    }

    #tooltip .effect {
      color: #4DCC80;
      margin-top: 8px;
      font-size: 11px;
    }

    #legend,
    #gates {
      position: absolute;
      background: rgba(10, 16, 36, 0.6);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 24px;
      color: #fff;
      font-size: 11px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    #legend:hover,
    #gates:hover {
      border-color: rgba(255, 255, 255, 0.2);
      background: rgba(10, 16, 36, 0.7);
    }

    #legend {
      top: 30px;
      right: 30px;
      min-width: 280px;
    }

    #gates {
      top: 30px;
      left: 30px;
      max-width: 300px;
    }

    #legend h2,
    #gates h2 {
      color: #FFD700;
      font-size: 16px;
      margin-bottom: 16px;
      font-weight: 700;
      letter-spacing: 1px;
    }

    #legend h3,
    #gates h3 {
      color: #B88A08;
      font-size: 11px;
      margin: 20px 0 10px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #gates .subtitle {
      color: #889;
      font-size: 12px;
      margin-bottom: 12px;
    }

    #gates ul {
      list-style: none;
      color: #aab;
      line-height: 1.8;
    }

    #gates li::before {
      content: "ãƒ»";
      color: #4A7AB8;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin: 6px 0;
    }

    .legend-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .legend-sphere {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      flex-shrink: 0;
    }

    .legend-text {
      flex: 1;
    }

    .legend-text .label {
      color: #fff;
    }

    .legend-text .desc {
      color: #889;
      font-size: 10px;
    }

    #editor-toggle {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid #FFD700;
      color: #FFD700;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    #editor-toggle:hover {
      background: rgba(255, 215, 0, 0.3);
    }

    #editor-toggle.active {
      background: rgba(255, 215, 0, 0.4);
    }

    #editor-panel {
      position: absolute;
      top: 0;
      right: -480px;
      width: 480px;
      height: 100vh;
      background: rgba(10, 16, 36, 0.98);
      border-left: 1px solid rgba(74, 122, 184, 0.5);
      padding: 20px;
      overflow-y: auto;
      transition: right 0.3s ease;
      z-index: 2000;
    }

    #editor-panel.open {
      right: 0;
    }

    #editor-panel h2 {
      color: #FFD700;
      font-size: 18px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #editor-panel .close-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
    }

    #editor-panel .close-btn:hover {
      color: #fff;
    }

    .editor-section {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(74, 122, 184, 0.2);
    }

    .editor-section h3 {
      color: #B88A08;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .node-list {
      max-height: 180px;
      overflow-y: auto;
      margin-bottom: 12px;
    }

    .node-list-item {
      display: flex;
      align-items: center;
      padding: 8px;
      margin: 4px 0;
      background: rgba(74, 122, 184, 0.1);
      border-radius: 6px;
      cursor: pointer;
    }

    .node-list-item:hover {
      background: rgba(74, 122, 184, 0.2);
    }

    .node-list-item.selected {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid rgba(255, 215, 0, 0.5);
    }

    .node-list-item .node-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .node-list-item .node-name {
      color: #fff;
      flex: 1;
      font-size: 12px;
    }

    .node-list-item .node-ring {
      color: #889;
      font-size: 10px;
      margin-right: 8px;
    }

    .node-list-item .node-state {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      color: #889;
      font-size: 11px;
      margin-bottom: 4px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      background: rgba(20, 30, 50, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #fff;
      font-size: 13px;
      backdrop-filter: blur(4px);
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #FFD700;
      background: rgba(20, 30, 50, 0.6);
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 60px;
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .sphere-editor {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .sphere-tag {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
    }

    .sphere-tag input {
      width: 30px;
      padding: 2px 4px;
      margin-left: 4px;
      text-align: center;
      font-size: 11px;
    }

    .ring-list {
      margin-bottom: 12px;
    }

    .ring-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0;
      padding: 8px;
      background: rgba(74, 122, 184, 0.1);
      border-radius: 6px;
    }

    .ring-item input {
      flex: 1;
    }

    .ring-item .ring-radius {
      width: 70px;
    }

    .ring-item .delete-ring {
      background: rgba(230, 77, 102, 0.3);
      border: none;
      color: #E64D66;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-primary {
      background: #FFD700;
      color: #000;
    }

    .btn-primary:hover {
      background: #FFE44D;
    }

    .btn-secondary {
      background: rgba(74, 122, 184, 0.3);
      color: #fff;
      border: 1px solid rgba(74, 122, 184, 0.5);
    }

    .btn-secondary:hover {
      background: rgba(74, 122, 184, 0.5);
    }

    .btn-danger {
      background: rgba(230, 77, 102, 0.3);
      color: #E64D66;
      border: 1px solid rgba(230, 77, 102, 0.5);
    }

    .btn-danger:hover {
      background: rgba(230, 77, 102, 0.5);
      color: #fff;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 11px;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .drag-hint {
      position: absolute;
      bottom: 60px;
      left: 20px;
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid rgba(255, 215, 0, 0.3);
      color: #FFD700;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      display: none;
    }

    .drag-hint.visible {
      display: block;
    }

    #export-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(74, 122, 184, 0.2);
    }

    #export-section h3 {
      color: #B88A08;
      font-size: 14px;
      margin-bottom: 12px;
    }
  </style>
</head>

<body>
  <div id="login-screen">
    <div class="login-box">
      <div class="login-logo">âš¡</div>
      <h1>WONDERFUL GROWTH</h1>
      <div class="subtitle">ä¼æ¥­ã‚¹ãƒ•ã‚£ã‚¢ç›¤ - ç¤¾å†…é™å®š</div>
      <input type="password" id="password-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="off">
      <button onclick="attemptLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div class="login-error" id="login-error"></div>
      <div class="login-hint">â€» ç¤¾å†…ãƒ¡ãƒ³ãƒãƒ¼ç”¨ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼</div>
    </div>
  </div>

  <div id="main-content">
    <div id="container"><canvas id="canvas"></canvas></div>
    <div id="tooltip"></div>
    <button id="logout-btn" onclick="logout()">ğŸ”“ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

    <div id="gates">
      <h2>WONDERFUL GROWTH</h2>
      <div class="subtitle">ä¼æ¥­ã‚¹ãƒ•ã‚£ã‚¢ç›¤</div>
      <h3>åŸºç›¤ã‚²ãƒ¼ãƒˆé”æˆæ¡ä»¶</h3>
      <ul>
        <li>ç¾é é‡‘ï¼šå›ºå®šè²»4ãƒ¶æœˆåˆ†ä»¥ä¸Š</li>
        <li>ç²—åˆ©ç‡ï¼š40%ä»¥ä¸Š</li>
        <li>ç¨¼åƒç‡ï¼š100%</li>
        <li>æ¡ç”¨ï¼šå¥‘ç´„æ¸ˆã¿Backlogã®ã¿</li>
        <li>ã‚ªãƒ•ã‚£ã‚¹ï¼šè³ƒæ–™ â‰¤ ç²—åˆ©15%</li>
      </ul>
    </div>

    <div id="legend">
      <h2>ãƒãƒ¼ãƒ‰çŠ¶æ…‹</h2>
      <div class="legend-item">
        <div class="legend-dot"
          style="background: radial-gradient(circle at 30% 30%, #FFF5CC, #FFD700); box-shadow: 0 0 12px #FFD700;"></div>
        <div class="legend-text"><span class="label">å®šç€</span><br><span class="desc">ç¿’å¾—å®Œäº†ãƒ»å®šç€æ¸ˆã¿</span></div>
      </div>
      <div class="legend-item">
        <div class="legend-dot"
          style="background: radial-gradient(circle at 30% 30%, #66E699, #33E680); box-shadow: 0 0 10px #33E680;"></div>
        <div class="legend-text"><span class="label">è§£æ”¾æ¸ˆ</span><br><span class="desc">ç¿’å¾—ä¸­ãƒ»å®Ÿæ–½ä¸­</span></div>
      </div>
      <div class="legend-item">
        <div class="legend-dot"
          style="background: radial-gradient(circle at 30% 30%, #FFE066, #FFD700); box-shadow: 0 0 8px #FFD700;"></div>
        <div class="legend-text"><span class="label">è§£æ”¾å¯</span><br><span class="desc">æ¡ä»¶ã‚¯ãƒªã‚¢ãƒ»è§£æ”¾å¯èƒ½</span></div>
      </div>
      <div class="legend-item">
        <div class="legend-dot"
          style="background: radial-gradient(circle at 30% 30%, #444, #333); border: 1px solid #555;"></div>
        <div class="legend-text"><span class="label">æœªè§£æ”¾</span><br><span class="desc">æ¡ä»¶æœªé”æˆ</span></div>
      </div>
      <h3>å¿…è¦ã‚¹ãƒ•ã‚£ã‚¢</h3>
      <div class="legend-item highlightable" onmouseenter="hoveredSphereType='äººæ';draw()"
        onmouseleave="hoveredSphereType=null;draw()">
        <div class="legend-sphere" style="background: #3399E6;"></div>
        <div class="legend-text"><span class="label">äººæ</span></div>
      </div>
      <div class="legend-item highlightable" onmouseenter="hoveredSphereType='è³‡é‡‘';draw()"
        onmouseleave="hoveredSphereType=null;draw()">
        <div class="legend-sphere" style="background: #E6B333;"></div>
        <div class="legend-text"><span class="label">è³‡é‡‘</span></div>
      </div>
      <div class="legend-item highlightable" onmouseenter="hoveredSphereType='å®Ÿç¸¾';draw()"
        onmouseleave="hoveredSphereType=null;draw()">
        <div class="legend-sphere" style="background: #4DCC80;"></div>
        <div class="legend-text"><span class="label">å®Ÿç¸¾</span></div>
      </div>
      <div class="legend-item highlightable" onmouseenter="hoveredSphereType='æ™‚é–“';draw()"
        onmouseleave="hoveredSphereType=null;draw()">
        <div class="legend-sphere" style="background: #9966CC;"></div>
        <div class="legend-text"><span class="label">æ™‚é–“</span></div>
      </div>
      <div class="legend-item highlightable" onmouseenter="hoveredSphereType='ä¿¡é ¼';draw()"
        onmouseleave="hoveredSphereType=null;draw()">
        <div class="legend-sphere" style="background: #E68033;"></div>
        <div class="legend-text"><span class="label">ä¿¡é ¼</span></div>
      </div>
      <div class="legend-item highlightable" onmouseenter="hoveredSphereType='æŠ€è¡“';draw()"
        onmouseleave="hoveredSphereType=null;draw()">
        <div class="legend-sphere" style="background: #66B3E6;"></div>
        <div class="legend-text"><span class="label">æŠ€è¡“</span></div>
      </div>
    </div>

    <button id="editor-toggle" onclick="toggleEditor()">ğŸ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
    <div id="drag-hint" class="drag-hint">ğŸ–±ï¸ ãƒãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç§»å‹•ã§ãã¾ã™</div>

    <div id="editor-panel">
      <h2>ã‚¹ãƒ•ã‚£ã‚¢ç›¤ã‚¨ãƒ‡ã‚£ã‚¿<button class="close-btn" onclick="toggleEditor()">Ã—</button></h2>

      <div class="editor-section">
        <h3>ãƒªãƒ³ã‚°ç®¡ç†</h3>
        <div class="ring-list" id="ring-list"></div>
        <button class="btn btn-secondary btn-small" onclick="addNewRing()">+ ãƒªãƒ³ã‚°è¿½åŠ </button>
      </div>

      <div class="editor-section">
        <h3>ãƒãƒ¼ãƒ‰ä¸€è¦§</h3>
        <div class="node-list" id="node-list"></div>
        <button class="btn btn-secondary btn-small" onclick="addNewNode()">+ ãƒãƒ¼ãƒ‰è¿½åŠ </button>
      </div>

      <div class="editor-section" id="node-editor" style="display: none;">
        <h3>ãƒãƒ¼ãƒ‰ç·¨é›† <span style="font-size:11px;color:#889;">(ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚‚ç§»å‹•å¯)</span></h3>
        <div class="form-row">
          <div class="form-group"><label>ID</label><input type="text" id="edit-id"></div>
          <div class="form-group"><label>ãƒªãƒ³ã‚°</label><select id="edit-ring"></select></div>
        </div>
        <div class="form-group"><label>ãƒ©ãƒ™ãƒ«ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã§æ”¹è¡Œï¼‰</label><input type="text" id="edit-label"></div>
        <div class="form-row">
          <div class="form-group"><label>çŠ¶æ…‹</label>
            <select id="edit-state">
              <option value="LOCKED">æœªè§£æ”¾</option>
              <option value="ELIGIBLE">è§£æ”¾å¯</option>
              <option value="UNLOCKED">è§£æ”¾æ¸ˆ</option>
              <option value="MASTERED">å®šç€</option>
            </select>
          </div>
          <div class="form-group"><label>è§’åº¦ (åº¦)</label><input type="number" id="edit-angle" min="-180" max="180"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>é‡è¦åº¦</label>
            <select id="edit-importance">
              <option value="STANDARD">æ¨™æº–</option>
              <option value="MAJOR">é‡è¦</option>
              <option value="MINOR">å°</option>
            </select>
          </div>
          <div class="form-group"><label>å½¢çŠ¶</label>
            <select id="edit-shape">
              <option value="circle">å††</option>
              <option value="hexagon">å…­è§’å½¢</option>
              <option value="diamond">è±å½¢</option>
              <option value="octagon">å…«è§’å½¢</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label>èª¬æ˜</label><textarea id="edit-description"></textarea></div>
        <div class="form-group"><label>åŠ¹æœ</label><input type="text" id="edit-effect"></div>
        <div class="form-group"><label>å¿…è¦ã‚¹ãƒ•ã‚£ã‚¢</label>
          <div class="sphere-editor" id="sphere-editor"></div>
        </div>
        <div class="form-group"><label>æ¥ç¶šå…ƒ</label><select id="edit-parent"></select></div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveNode()">ä¿å­˜</button>
          <button class="btn btn-danger" onclick="deleteNode()">å‰Šé™¤</button>
          <button class="btn btn-secondary" onclick="cancelEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>

      <div id="export-section">
        <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
        <div class="btn-group">
          <button class="btn btn-secondary btn-small" onclick="exportData()">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button class="btn btn-secondary btn-small" onclick="importData()">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <button class="btn btn-secondary btn-small" onclick="downloadImage()">ğŸ–¼ï¸ ç”»åƒä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // èªè¨¼
    const ACCESS_PASSWORD = 'wg2024';
    const AUTH_KEY = 'wg_sphere_auth';
    const AUTH_EXPIRY_DAYS = 7;

    function checkAuth() {
      const d = localStorage.getItem(AUTH_KEY);
      if (!d) return false;
      try {
        const { hash, expiry } = JSON.parse(d);
        if (Date.now() > expiry) { localStorage.removeItem(AUTH_KEY); return false; }
        return hash === simpleHash(ACCESS_PASSWORD);
      } catch { return false; }
    }
    function simpleHash(s) { let h = 0; for (let i = 0; i < s.length; i++) { h = ((h << 5) - h) + s.charCodeAt(i); h &= h; } return h.toString(36); }
    function attemptLogin() {
      const inp = document.getElementById('password-input');
      if (inp.value === ACCESS_PASSWORD) {
        localStorage.setItem(AUTH_KEY, JSON.stringify({ hash: simpleHash(ACCESS_PASSWORD), expiry: Date.now() + AUTH_EXPIRY_DAYS * 86400000 }));
        showMainContent();
      } else { document.getElementById('login-error').textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'; inp.value = ''; inp.focus(); }
    }
    function logout() { if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem(AUTH_KEY); location.reload(); } }
    function showMainContent() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('main-content').classList.add('visible'); initApp(); }
    document.getElementById('password-input').addEventListener('keypress', e => { if (e.key === 'Enter') attemptLogin(); });
    if (checkAuth()) showMainContent(); else document.getElementById('password-input').focus();

    // CONFIG
    let CONFIG = {
      width: 1920, height: 1080,
      rings: [
        { id: "R30", label: "å¹´å•† 3,000ä¸‡", radius: 180 },
        { id: "R60", label: "å¹´å•† 6,000ä¸‡", radius: 300 },
        { id: "R100", label: "å¹´å•† 1å„„", radius: 420 },
      ],
      sphereTypes: {
        "äººæ": { color: "#3399E6" }, "è³‡é‡‘": { color: "#E6B333" }, "å®Ÿç¸¾": { color: "#4DCC80" },
        "æ™‚é–“": { color: "#9966CC" }, "ä¿¡é ¼": { color: "#E68033" }, "æŠ€è¡“": { color: "#66B3E6" },
      },
      nodes: [
        { id: "CORE", label: "WG\nCORE", ring: "CORE", angleDeg: 0, state: "MASTERED", importance: "MAJOR", shape: "octagon", sizeMultiplier: 1.4, description: "ä¼æ¥­ã®æ ¸å¿ƒ", effect: "å…¨ãƒãƒ¼ãƒ‰è§£æ”¾", requirements: [] },
        { id: "HIRE_3", label: "æ¡ç”¨\nã€œ3å", ring: "R30", angleDeg: -45, state: "ELIGIBLE", importance: "STANDARD", shape: "circle", description: "æœ€åˆã®æ¡ç”¨", effect: "ã‚­ãƒ£ãƒ‘+30%", requirements: [{ type: "è³‡é‡‘", count: 2 }, { type: "å®Ÿç¸¾", count: 1 }] },
        { id: "OFFICE_15", label: "ã‚ªãƒ•ã‚£ã‚¹\nè³ƒæ–™â‰¤15%", ring: "R30", angleDeg: 15, state: "ELIGIBLE", importance: "STANDARD", shape: "diamond", description: "é©æ­£ã‚³ã‚¹ãƒˆ", effect: "å›ºå®šè²»æœ€é©åŒ–", requirements: [{ type: "è³‡é‡‘", count: 1 }] },
        { id: "PRODUCTIZE", label: "å‹åŒ–\nç ”ä¿®å•†å“", ring: "R30", angleDeg: 75, state: "ELIGIBLE", importance: "MAJOR", shape: "hexagon", sizeMultiplier: 1.15, description: "ã‚µãƒ¼ãƒ“ã‚¹æ¨™æº–åŒ–", effect: "å†ç¾æ€§+50%", requirements: [{ type: "æŠ€è¡“", count: 2 }, { type: "æ™‚é–“", count: 1 }] },
        { id: "BACKOFFICE", label: "ãƒãƒƒã‚¯\nã‚ªãƒ•ã‚£ã‚¹", ring: "R30", angleDeg: 150, state: "ELIGIBLE", importance: "STANDARD", shape: "circle", description: "ç®¡ç†åŸºç›¤æ•´å‚™", effect: "ç®¡ç†åŠ¹ç‡+20%", requirements: [{ type: "è³‡é‡‘", count: 1 }, { type: "äººæ", count: 1 }] },
        { id: "WELFARE", label: "ç¦åˆ©åšç”Ÿ\nå°å…¥", ring: "R60", angleDeg: -60, state: "LOCKED", importance: "STANDARD", shape: "circle", description: "æº€è¶³åº¦å‘ä¸Š", effect: "å®šç€ç‡+15%", requirements: [{ type: "è³‡é‡‘", count: 2 }, { type: "ä¿¡é ¼", count: 1 }] },
        { id: "HIRE_MORE", label: "æ¡ç”¨\nè¿½åŠ ", ring: "R60", angleDeg: -15, state: "LOCKED", importance: "MAJOR", shape: "circle", sizeMultiplier: 1.15, description: "äººæç¢ºä¿", effect: "ã‚­ãƒ£ãƒ‘+50%", requirements: [{ type: "è³‡é‡‘", count: 3 }, { type: "äººæ", count: 1 }, { type: "å®Ÿç¸¾", count: 2 }] },
        { id: "SEC_PREP", label: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£\nèªè¨¼æº–å‚™", ring: "R60", angleDeg: 45, state: "LOCKED", importance: "STANDARD", shape: "diamond", description: "èªè¨¼æº–å‚™", effect: "å¤§ä¼æ¥­å¯¾å¿œ", requirements: [{ type: "æŠ€è¡“", count: 2 }, { type: "æ™‚é–“", count: 2 }] },
        { id: "SALES_PROCESS", label: "å–¶æ¥­\nãƒ—ãƒ­ã‚»ã‚¹", ring: "R60", angleDeg: 115, state: "LOCKED", importance: "MAJOR", shape: "hexagon", sizeMultiplier: 1.15, description: "å–¶æ¥­ä½“ç³»åŒ–", effect: "å—æ³¨åŠ¹ç‡+40%", requirements: [{ type: "å®Ÿç¸¾", count: 2 }, { type: "æŠ€è¡“", count: 1 }] },
        { id: "NEW_BIZ", label: "æ–°è¦äº‹æ¥­\nÃ—1", ring: "R100", angleDeg: -30, state: "LOCKED", importance: "MAJOR", shape: "octagon", sizeMultiplier: 1.2, description: "æ–°é ˜åŸŸé€²å‡º", effect: "åç›Šå¤šè§’åŒ–", requirements: [{ type: "è³‡é‡‘", count: 5 }, { type: "äººæ", count: 2 }, { type: "å®Ÿç¸¾", count: 3 }] },
        { id: "FUNCTION_SPLIT", label: "å°‚ä»»æ©Ÿèƒ½\nåˆ†é›¢", ring: "R100", angleDeg: 30, state: "LOCKED", importance: "STANDARD", shape: "circle", description: "å°‚ä»»ä½“åˆ¶", effect: "å°‚é–€æ€§æ·±åŒ–", requirements: [{ type: "äººæ", count: 3 }, { type: "è³‡é‡‘", count: 2 }] },
        { id: "SEC_GET", label: "èªè¨¼\næœ¬å–å¾—", ring: "R100", angleDeg: 90, state: "LOCKED", importance: "MAJOR", shape: "diamond", sizeMultiplier: 1.15, description: "èªè¨¼å–å¾—", effect: "å¤§å‹æ¡ˆä»¶ç²å¾—", requirements: [{ type: "æŠ€è¡“", count: 3 }, { type: "æ™‚é–“", count: 3 }, { type: "è³‡é‡‘", count: 2 }] },
        { id: "LEAD_DEV", label: "ãƒªãƒ¼ãƒ‰\nè‚²æˆ", ring: "R100", angleDeg: 160, state: "LOCKED", importance: "MAJOR", shape: "circle", sizeMultiplier: 1.15, description: "ãƒªãƒ¼ãƒ€ãƒ¼è‚²æˆ", effect: "æŒç¶šå¯èƒ½æ€§", requirements: [{ type: "äººæ", count: 2 }, { type: "æ™‚é–“", count: 3 }, { type: "ä¿¡é ¼", count: 2 }] },
      ],
      edges: [
        { from: "CORE", to: "HIRE_3", type: "MAIN" }, { from: "CORE", to: "OFFICE_15", type: "MAIN" },
        { from: "CORE", to: "PRODUCTIZE", type: "MAIN" }, { from: "CORE", to: "BACKOFFICE", type: "MAIN" },
        { from: "HIRE_3", to: "WELFARE", type: "OPTIONAL" }, { from: "HIRE_3", to: "HIRE_MORE", type: "MAIN" },
        { from: "HIRE_MORE", to: "FUNCTION_SPLIT", type: "MAIN" }, { from: "FUNCTION_SPLIT", to: "LEAD_DEV", type: "MAIN" },
        { from: "PRODUCTIZE", to: "SALES_PROCESS", type: "MAIN" }, { from: "SALES_PROCESS", to: "NEW_BIZ", type: "MAIN" },
        { from: "SALES_PROCESS", to: "SEC_PREP", type: "OPTIONAL" }, { from: "SEC_PREP", to: "SEC_GET", type: "MAIN" },
        { from: "BACKOFFICE", to: "SEC_PREP", type: "CROSS_DOMAIN" },
      ],
      nodeSizes: { MAJOR: 55, STANDARD: 45, MINOR: 35 }
    };

    let canvas, ctx, tooltip;
    let baseScale = 1, userZoom = 1, offsetX = 0, offsetY = 0;
    let cx, cy;
    let nodePositions = [];
    let selectedNodeId = null;
    let hoveredSphereType = null;
    let highlightedPathNodes = new Set();
    let isEditorOpen = false;
    let isDragging = false;
    let isPanning = false;
    let dragNode = null;
    let dragStartPos = null;
    let panStartPos = null;

    function initApp() {
      canvas = document.getElementById('canvas');
      ctx = canvas.getContext('2d');
      tooltip = document.getElementById('tooltip');
      window.addEventListener('resize', resize);
      canvas.addEventListener('mousemove', handleMouseMove);
      canvas.addEventListener('mousedown', handleMouseDown);
      canvas.addEventListener('mouseup', handleMouseUp);
      canvas.addEventListener('mouseleave', handleMouseLeave);
      canvas.addEventListener('wheel', handleWheel, { passive: false });
      resize();
      requestAnimationFrame(animate);
    }

    function animate() {
      draw();
      requestAnimationFrame(animate);
    }

    function resize() {
      const dpr = window.devicePixelRatio || 1;
      const w = window.innerWidth, h = window.innerHeight;
      canvas.width = w * dpr; canvas.height = h * dpr;
      canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      baseScale = Math.min(w / CONFIG.width, h / CONFIG.height) * 0.9;
      cx = w / 2; cy = h / 2;
      draw();
    }

    function findNodeAt(x, y) {
      for (const { node, x: nx, y: ny, size } of nodePositions) {
        if (Math.sqrt((x - nx) ** 2 + (y - ny) ** 2) < size * 1.2) return node;
      }
      return null;
    }

    function handleMouseMove(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left, y = e.clientY - rect.top;

      if (isPanning) {
        offsetX += x - panStartPos.x;
        offsetY += y - panStartPos.y;
        panStartPos = { x, y };
        return;
      }

      if (isDragging && dragNode && dragNode.ring !== 'CORE') {
        const sx = baseScale * userZoom;
        const dx = (x - cx - offsetX) / sx, dy = (y - cy - offsetY) / sx;
        const dist = Math.sqrt(dx * dx + dy * dy);
        let angleDeg = Math.atan2(dy, dx) * 180 / Math.PI;
        dragNode.angleDeg = Math.round(angleDeg);
        // ã‚¹ãƒŠãƒƒãƒ—å…ˆã®ãƒªãƒ³ã‚°ã‚’æ¢ã™
        let closestRing = CONFIG.rings[0];
        let minDiff = Infinity;
        for (const ring of CONFIG.rings) {
          const diff = Math.abs(dist - ring.radius);
          if (diff < minDiff) { minDiff = diff; closestRing = ring; }
        }
        dragNode.ring = closestRing.id;
        if (isEditorOpen) { updateNodeList(); populateNodeEditor(dragNode); }
        return;
      }

      const hovered = findNodeAt(x, y);
      if (hovered) {
        if (isEditorOpen && hovered.ring !== 'CORE') { canvas.classList.add('can-drag'); } else { canvas.classList.remove('can-drag'); }
        showTooltip(hovered, e.clientX, e.clientY);
      } else {
        canvas.classList.remove('can-drag');
        hideTooltip();
      }
    }

    function handleMouseDown(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left, y = e.clientY - rect.top;

      if (e.button === 1 || (e.button === 0 && e.shiftKey)) {
        isPanning = true;
        panStartPos = { x, y };
        canvas.classList.add('dragging');
        return;
      }

      if (!isEditorOpen) return;
      const node = findNodeAt(x, y);
      if (node && node.ring !== 'CORE') {
        isDragging = true;
        dragNode = node;
        dragStartPos = { x, y };
        canvas.classList.add('dragging');
        canvas.classList.remove('can-drag');
        selectNode(node.id);
      }
    }

    function handleMouseUp(e) {
      isDragging = false;
      isPanning = false;
      dragNode = null;
      canvas.classList.remove('dragging');
      draw();
    }

    function handleWheel(e) {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left, y = e.clientY - rect.top;

      const zoomFactor = 1.1;
      const oldZoom = userZoom;
      if (e.deltaY < 0) userZoom *= zoomFactor;
      else userZoom /= zoomFactor;

      userZoom = Math.min(Math.max(userZoom, 0.2), 5);

      // ãƒã‚¦ã‚¹ä½ç½®ã‚’ä¸­å¿ƒã«ã‚ºãƒ¼ãƒ 
      const sx = baseScale * oldZoom;
      const nx = baseScale * userZoom;
      offsetX -= (x - cx - offsetX) * (nx / sx - 1);
      offsetY -= (y - cy - offsetY) * (nx / sx - 1);
    }

    function handleMouseLeave() {
      hideTooltip();
      if (isDragging) { isDragging = false; dragNode = null; canvas.classList.remove('dragging'); draw(); }
    }

    // æç”»
    function draw() {
      const w = canvas.width / (window.devicePixelRatio || 1), h = canvas.height / (window.devicePixelRatio || 1);
      ctx.fillStyle = '#03060f'; ctx.fillRect(0, 0, w, h);
      drawStars(w, h); drawGlow(); drawRings(); drawEdges();
      nodePositions = [];
      CONFIG.nodes.forEach(n => { const p = drawNode(n); nodePositions.push({ node: n, ...p }); });
      if (hoveredSphereType) drawSphereConnections();
    }

    function drawSphereConnections() {
      const color = CONFIG.sphereTypes[hoveredSphereType].color;
      const targetNodes = nodePositions.filter(np => np.node.requirements?.some(r => r.type === hoveredSphereType));
      const w = canvas.width / (window.devicePixelRatio || 1);
      const legendX = w - 100, legendY = 200; // å‡¡ä¾‹ã®æ¦‚ç®—ä½ç½®

      targetNodes.forEach(np => {
        ctx.beginPath();
        ctx.setLineDash([5, 5]);
        ctx.lineDashOffset = -Date.now() * 0.01;
        ctx.moveTo(legendX, legendY);
        ctx.quadraticCurveTo((legendX + np.x) / 2, legendY - 50, np.x, np.y);
        ctx.strokeStyle = color + '44';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.setLineDash([]);
      });
    }

    function drawStars(w, h) {
      const time = Date.now() * 0.0005;
      let seed = 54321;
      const rnd = () => { seed = (seed * 1103515245 + 12345) & 0x7fffffff; return seed / 0x7fffffff; };
      [[150, 0.5, 1.2, 0.1, 0.3], [70, 1, 2, 0.2, 0.5], [30, 2, 4, 0.4, 0.8]].forEach(([c, s1, s2, o1, o2], idx) => {
        for (let i = 0; i < c; i++) {
          const rx = rnd(), ry = rnd();
          const pScale = 1 + idx * 0.2;
          const x = (rx * w + Math.sin(time * pScale + rx * 10) * 10) % w, y = (ry * h + Math.cos(time * pScale + ry * 10) * 10) % h;
          if (Math.sqrt((x - cx) ** 2 + (y - cy) ** 2) < 120 * baseScale * userZoom) continue;
          const sz = s1 + rnd() * (s2 - s1), op = o1 + rnd() * (o2 - o1) * (0.5 + 0.5 * Math.sin(time + rx * 20));
          ctx.beginPath(); ctx.arc(x, y, sz, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255,255,255,${op})`; ctx.fill();
        }
      });
    }

    function drawGlow() {
      const r = 500 * baseScale * userZoom;
      const g = ctx.createRadialGradient(cx + offsetX, cy + offsetY, 0, cx + offsetX, cy + offsetY, r);
      g.addColorStop(0, 'rgba(20,36,66,0.6)'); g.addColorStop(0.5, 'rgba(20,36,66,0.3)'); g.addColorStop(1, 'rgba(20,36,66,0)');
      ctx.beginPath(); ctx.arc(cx + offsetX, cy + offsetY, r, 0, Math.PI * 2); ctx.fillStyle = g; ctx.fill();
    }

    function drawRings() {
      CONFIG.rings.forEach((ring, i) => {
        const r = ring.radius * baseScale * userZoom;
        const intensity = 1 - i * 0.15;
        ctx.beginPath(); ctx.arc(cx + offsetX, cy + offsetY, r, 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(74,122,184,${0.15 * intensity})`; ctx.lineWidth = 6 * userZoom; ctx.stroke();
        ctx.beginPath(); ctx.arc(cx + offsetX, cy + offsetY, r, 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(74,122,184,${0.4 + 0.3 * intensity})`; ctx.lineWidth = 1.5; ctx.stroke();
        ctx.font = `${12 * userZoom}px "Outfit", sans-serif`;
        ctx.fillStyle = `rgba(180,200,220,${0.5 + 0.3 * intensity})`;
        ctx.textAlign = 'left'; ctx.fillText(ring.label, cx + offsetX + r + 15, cy + offsetY + 4);
      });
    }

    function getNodePos(node) {
      const sx = baseScale * userZoom;
      if (node.ring === 'CORE') return { x: cx + offsetX, y: cy + offsetY };
      const ring = CONFIG.rings.find(r => r.id === node.ring);
      const r = ring ? ring.radius * sx : 180 * sx;
      const rad = (node.angleDeg * Math.PI) / 180;
      return { x: cx + offsetX + r * Math.cos(rad), y: cy + offsetY + r * Math.sin(rad) };
    }

    function drawEdges() {
      const time = Date.now() * 0.002;
      const map = new Map(); CONFIG.nodes.forEach(n => map.set(n.id, getNodePos(n)));
      CONFIG.edges.forEach(e => {
        const a = map.get(e.from), b = map.get(e.to); if (!a || !b) return;
        const isMain = e.type === 'MAIN', isCross = e.type === 'CROSS_DOMAIN';

        ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y);
        ctx.strokeStyle = `rgba(58,96,144,${isMain ? 0.2 : 0.1})`; ctx.lineWidth = isMain ? 10 : 6; ctx.lineCap = 'round'; ctx.stroke();

        ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y);
        const grad = ctx.createLinearGradient(a.x, a.y, b.x, b.y);
        const c1 = isCross ? 'rgba(184,138,8,0.4)' : `rgba(74,122,184,${isMain ? 0.6 : 0.3})`;
        grad.addColorStop(0, c1); grad.addColorStop(0.5, isCross ? 'rgba(255,215,0,0.8)' : `rgba(100,180,255,${isMain ? 0.9 : 0.5})`); grad.addColorStop(1, c1);
        ctx.strokeStyle = grad; ctx.lineWidth = isMain ? 3 : 1.5;
        if (e.type === 'OPTIONAL') ctx.setLineDash([6, 4]); else ctx.setLineDash([]);
        ctx.stroke(); ctx.setLineDash([]);

        if (isMain) {
          const dist = Math.sqrt((b.x - a.x) ** 2 + (b.y - a.y) ** 2);
          const dotPos = (time % 1) * dist;
          const angle = Math.atan2(b.y - a.y, b.x - a.x);
          const dx = a.x + Math.cos(angle) * dotPos, dy = a.y + Math.sin(angle) * dotPos;
          ctx.beginPath(); ctx.arc(dx, dy, 2, 0, Math.PI * 2); ctx.fillStyle = '#fff';
          ctx.shadowBlur = 10; ctx.shadowColor = '#fff'; ctx.fill(); ctx.shadowBlur = 0;
        }

        // ãƒ‘ã‚¹å¼·èª¿
        if (highlightedPathNodes.has(e.from) && highlightedPathNodes.has(e.to)) {
          ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y);
          ctx.strokeStyle = 'rgba(255,215,0,0.4)'; ctx.lineWidth = (isMain ? 6 : 3); ctx.stroke();
        }
      });
    }

    function getPathToCore(nodeId) {
      const path = [nodeId];
      let currentId = nodeId;
      while (currentId !== 'CORE') {
        const edge = CONFIG.edges.find(e => e.to === currentId);
        if (!edge) break;
        currentId = edge.from;
        path.push(currentId);
      }
      return path;
    }

    function calculateTotalCost(path) {
      const cost = {};
      path.forEach(nodeId => {
        const node = CONFIG.nodes.find(n => n.id === nodeId);
        if (node && node.state !== 'MASTERED') {
          node.requirements?.forEach(r => {
            cost[r.type] = (cost[r.type] || 0) + r.count;
          });
        }
      });
      return cost;
    }

    function drawNode(node) {
      const pos = getNodePos(node);
      const baseSize = CONFIG.nodeSizes[node.importance] || 45;
      const size = baseSize * (node.sizeMultiplier || 1) * baseScale * userZoom;
      const time = Date.now() * 0.002;
      let fill, stroke, glowColor;
      switch (node.state) {
        case 'MASTERED': fill = '#3a2d0a'; stroke = '#ffe066'; glowColor = 'rgba(255,215,0,0.5)'; break;
        case 'UNLOCKED': fill = '#0a2d1a'; stroke = '#4dcc80'; glowColor = 'rgba(77,204,128,0.4)'; break;
        case 'ELIGIBLE': fill = '#2d250a'; stroke = '#ffd700'; glowColor = 'rgba(255,215,0,0.3)'; break;
        default: fill = '#1a1d24'; stroke = '#3a3e48'; glowColor = null;
      }

      // ç´¯è¨ˆå¿…è¦ã‚¹ãƒ•ã‚£ã‚¢å¼·èª¿
      if (hoveredSphereType && node.requirements?.some(r => r.type === hoveredSphereType)) {
        glowColor = CONFIG.sphereTypes[hoveredSphereType].color + 'cc';
      }
      if (node.id === selectedNodeId) {
        ctx.beginPath(); ctx.arc(pos.x, pos.y, size * 1.5, 0, Math.PI * 2);
        ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 2; ctx.setLineDash([5, 5]); ctx.lineDashOffset = -time * 5; ctx.stroke(); ctx.setLineDash([]);
      }
      if (glowColor && node.state !== 'LOCKED') {
        const pulse = 0.8 + 0.2 * Math.sin(time);
        const g = ctx.createRadialGradient(pos.x, pos.y, size * 0.5 * pulse, pos.x, pos.y, size * (1.5 + 0.2 * pulse));
        g.addColorStop(0, glowColor); g.addColorStop(1, 'rgba(0,0,0,0)');
        ctx.beginPath(); ctx.arc(pos.x, pos.y, size * 2, 0, Math.PI * 2); ctx.fillStyle = g; ctx.fill();
      }
      ctx.beginPath();
      if (node.shape === 'circle') ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
      else if (node.shape === 'hexagon') drawPoly(pos.x, pos.y, size, 6, Math.PI / 6);
      else if (node.shape === 'diamond') drawPoly(pos.x, pos.y, size, 4, 0);
      else if (node.shape === 'octagon') drawPoly(pos.x, pos.y, size, 8, Math.PI / 8);

      const fg = ctx.createRadialGradient(pos.x - size * 0.3, pos.y - size * 0.3, size * 0.1, pos.x, pos.y, size);
      fg.addColorStop(0, lighten(fill, 0.4)); fg.addColorStop(0.5, fill); fg.addColorStop(1, darken(fill, 0.4));
      ctx.fillStyle = fg; ctx.fill();
      ctx.strokeStyle = stroke; ctx.lineWidth = node.state === 'MASTERED' ? 3 : 2; ctx.stroke();

      // å…‰æ²¢
      ctx.beginPath(); ctx.ellipse(pos.x - size * 0.3, pos.y - size * 0.3, size * 0.4, size * 0.2, -Math.PI / 4, 0, Math.PI * 2);
      const gloss = ctx.createRadialGradient(pos.x - size * 0.3, pos.y - size * 0.3, 0, pos.x - size * 0.3, pos.y - size * 0.3, size * 0.4);
      gloss.addColorStop(0, 'rgba(255,255,255,0.3)'); gloss.addColorStop(1, 'rgba(255,255,255,0)');
      ctx.fillStyle = gloss; ctx.fill();

      ctx.font = `600 ${11 * baseScale * userZoom}px "Outfit", sans-serif`;
      ctx.fillStyle = node.state === 'LOCKED' ? '#556' : '#fff';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      const lines = node.label.split('\n'), lh = 14 * baseScale * userZoom, startY = pos.y - ((lines.length - 1) * lh) / 2;
      lines.forEach((l, i) => ctx.fillText(l, pos.x, startY + i * lh));

      if (node.state === 'LOCKED') { ctx.font = `${10 * baseScale * userZoom}px sans-serif`; ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.fillText('ğŸ”’', pos.x + size * 0.6, pos.y - size * 0.6); }
      if (node.requirements?.length && node.ring !== 'CORE') drawReqs(node, pos, size);
      return { x: pos.x, y: pos.y, size };
    }
    function darken(hex, amt) {
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      if (!m) return hex;
      return `rgb(${Math.max(0, parseInt(m[1], 16) - amt * 255)},${Math.max(0, parseInt(m[2], 16) - amt * 255)},${Math.max(0, parseInt(m[3], 16) - amt * 255)})`;
    }

    function drawReqs(node, pos, size) {
      const dx = pos.x - (cx + offsetX), dy = pos.y - (cy + offsetY), dist = Math.sqrt(dx * dx + dy * dy);
      const dirX = dist > 0 ? dx / dist : 0, dirY = dist > 0 ? dy / dist : 1;
      const off = size + 15 * baseScale * userZoom, lx = pos.x + dirX * off, ly = pos.y + dirY * off;
      const ss = 6 * baseScale * userZoom, sp = 14 * baseScale * userZoom, tw = node.requirements.length * sp;
      let sx = lx - tw / 2; if (dirX > 0.5) sx = lx; else if (dirX < -0.5) sx = lx - tw;
      node.requirements.forEach((r, i) => {
        const rx = sx + i * sp + ss / 2, ry = ly;
        const c = CONFIG.sphereTypes[r.type]?.color || '#888';
        ctx.beginPath(); ctx.arc(rx, ry, ss, 0, Math.PI * 2); ctx.fillStyle = c; ctx.fill();
        ctx.font = `bold ${8 * baseScale * userZoom}px sans-serif`; ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(r.count.toString(), rx, ry);
      });
    }

    function drawPoly(x, y, r, sides, rot = 0) {
      ctx.moveTo(x + r * Math.cos(rot), y + r * Math.sin(rot));
      for (let i = 1; i <= sides; i++) { const a = rot + (i * 2 * Math.PI) / sides; ctx.lineTo(x + r * Math.cos(a), y + r * Math.sin(a)); }
      ctx.closePath();
    }

    function lighten(hex, amt) {
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      if (!m) return hex;
      return `rgb(${Math.min(255, parseInt(m[1], 16) + amt * 255)},${Math.min(255, parseInt(m[2], 16) + amt * 255)},${Math.min(255, parseInt(m[3], 16) + amt * 255)})`;
    }

    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
    function showTooltip(node, x, y) {
      highlightedPathNodes = new Set(getPathToCore(node.id));
      const totalCost = calculateTotalCost(Array.from(highlightedPathNodes));

      let h = `<h3>${node.label.replace('\n', ' ')}</h3><span class="state ${node.state}">${getStateName(node.state)}</span>`;
      h += `<div class="description">${node.description || ''}</div>`;

      if (node.requirements?.length) {
        h += '<div class="requirements"><h4>ã“ã®é …ç›®ã®å¿…è¦ã‚¹ãƒ•ã‚£ã‚¢</h4>';
        node.requirements.forEach(r => {
          const c = CONFIG.sphereTypes[r.type]?.color || '#888';
          h += `<span class="sphere-item" style="background:${c}33;color:${c}">${r.type} Ã—${r.count}</span>`;
        });
        h += '</div>';
      }

      if (Object.keys(totalCost).length > 0) {
        h += '<div class="total-cost" style="margin-top:12px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1)">';
        h += '<h4 style="color:#FFD700; font-size:11px; margin-bottom:6px;">æœ€çŸ­ãƒ«ãƒ¼ãƒˆç´¯è¨ˆã‚³ã‚¹ãƒˆ</h4>';
        Object.entries(totalCost).forEach(([type, count]) => {
          const c = CONFIG.sphereTypes[type]?.color || '#888';
          h += `<div style="display:inline-flex; align-items:center; margin-right:12px; font-size:11px;">
            <div style="width:8px; height:8px; border-radius:50%; background:${c}; margin-right:4px;"></div>
            <span>${type} Ã—${count}</span>
          </div>`;
        });
        h += '</div>';
      }

      if (node.effect) h += `<div class="effect" style="margin-top:8px; color:#33E680; font-size:11px;">â†’ ${node.effect}</div>`;
      tooltip.innerHTML = h; tooltip.style.display = 'block';
      const tr = tooltip.getBoundingClientRect();
      let left = x + 15, top = y + 15;
      if (left + tr.width > window.innerWidth) left = x - tr.width - 15;
      if (top + tr.height > window.innerHeight) top = y - tr.height - 15;
      tooltip.style.left = left + 'px'; tooltip.style.top = top + 'px';
      draw();
    }
    function hideTooltip() { tooltip.style.display = 'none'; highlightedPathNodes = new Set(); draw(); }
    function getStateName(s) { return { MASTERED: 'å®šç€', UNLOCKED: 'è§£æ”¾æ¸ˆ', ELIGIBLE: 'è§£æ”¾å¯', LOCKED: 'æœªè§£æ”¾' }[s] || 'æœªè§£æ”¾'; }

    // ã‚¨ãƒ‡ã‚£ã‚¿
    function toggleEditor() {
      isEditorOpen = !isEditorOpen;
      document.getElementById('editor-panel').classList.toggle('open', isEditorOpen);
      document.getElementById('editor-toggle').classList.toggle('active', isEditorOpen);
      document.getElementById('editor-toggle').textContent = isEditorOpen ? 'âœ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰' : 'ğŸ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
      document.getElementById('drag-hint').classList.toggle('visible', isEditorOpen);
      if (isEditorOpen) { updateRingList(); updateNodeList(); updateRingSelect(); }
    }

    function updateRingList() {
      const list = document.getElementById('ring-list');
      list.innerHTML = '';
      CONFIG.rings.forEach((ring, i) => {
        const item = document.createElement('div'); item.className = 'ring-item';
        item.innerHTML = `
          <div style="display:flex; flex-direction:column; gap:2px;">
            <button class="btn btn-secondary btn-small" onclick="moveRing(${i}, -1)" ${i === 0 ? 'disabled' : ''} style="padding:2px 4px; font-size:9px;">â–²</button>
            <button class="btn btn-secondary btn-small" onclick="moveRing(${i}, 1)" ${i === CONFIG.rings.length - 1 ? 'disabled' : ''} style="padding:2px 4px; font-size:9px;">â–¼</button>
          </div>
          <input type="text" value="${ring.label}" onchange="updateRing(${i},'label',this.value)" style="flex:2">
          <input type="number" class="ring-radius" value="${ring.radius}" onchange="updateRing(${i},'radius',+this.value)" min="100" max="800">
          <button class="delete-ring" onclick="deleteRing(${i})" ${CONFIG.rings.length <= 1 ? 'disabled' : ''}>Ã—</button>
        `;
        list.appendChild(item);
      });
    }

    function moveRing(index, direction) {
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= CONFIG.rings.length) return;
      const temp = CONFIG.rings[index];
      CONFIG.rings[index] = CONFIG.rings[newIndex];
      CONFIG.rings[newIndex] = temp;
      updateRingList(); updateRingSelect(); draw();
    }

    function updateRing(i, key, val) { CONFIG.rings[i][key] = val; draw(); updateRingSelect(); }
    function deleteRing(i) {
      if (CONFIG.rings.length <= 1) return;
      const rid = CONFIG.rings[i].id;
      CONFIG.nodes = CONFIG.nodes.filter(n => n.ring !== rid);
      CONFIG.rings.splice(i, 1);
      updateRingList(); updateNodeList(); updateRingSelect(); draw();
    }
    function addNewRing() {
      const maxR = CONFIG.rings.length > 0 ? Math.max(...CONFIG.rings.map(r => r.radius)) : 100;
      const newId = 'R' + (maxR + 120);
      CONFIG.rings.push({ id: newId, label: 'æ–°ãƒªãƒ³ã‚°', radius: maxR + 120 });
      updateRingList(); updateRingSelect(); draw();
    }

    function updateRingSelect() {
      const sel = document.getElementById('edit-ring');
      sel.innerHTML = CONFIG.rings.map(r => `<option value="${r.id}">${r.label} (${r.radius}px)</option>`).join('');
    }

    function updateNodeList() {
      const list = document.getElementById('node-list'); list.innerHTML = '';
      CONFIG.nodes.filter(n => n.id !== 'CORE').forEach(node => {
        const item = document.createElement('div');
        item.className = 'node-list-item' + (node.id === selectedNodeId ? ' selected' : '');
        item.onclick = () => selectNode(node.id);
        const colors = { MASTERED: '#FFD700', UNLOCKED: '#33E680', ELIGIBLE: '#FFD700', LOCKED: '#4A4E58' };
        item.innerHTML = `
          <div class="node-dot" style="background:${colors[node.state]}"></div>
          <span class="node-name">${node.label.replace('\n', ' ')}</span>
          <span class="node-ring">${node.ring}</span>
          <span class="node-state state ${node.state}">${getStateName(node.state)}</span>
        `;
        list.appendChild(item);
      });
      const parent = document.getElementById('edit-parent');
      parent.innerHTML = '<option value="CORE">CORE</option>' + CONFIG.nodes.filter(n => n.id !== 'CORE').map(n => `<option value="${n.id}">${n.label.replace('\n', ' ')}</option>`).join('');
    }

    function selectNode(id) {
      selectedNodeId = id;
      const node = CONFIG.nodes.find(n => n.id === id);
      if (!node) return;
      document.getElementById('node-editor').style.display = 'block';
      populateNodeEditor(node);
      updateNodeList(); draw();
    }

    function populateNodeEditor(node) {
      document.getElementById('edit-id').value = node.id;
      document.getElementById('edit-label').value = node.label.replace('\n', ' ');
      document.getElementById('edit-ring').value = node.ring;
      document.getElementById('edit-state').value = node.state;
      document.getElementById('edit-angle').value = node.angleDeg;
      document.getElementById('edit-importance').value = node.importance;
      document.getElementById('edit-shape').value = node.shape;
      document.getElementById('edit-description').value = node.description || '';
      document.getElementById('edit-effect').value = node.effect || '';
      const se = document.getElementById('sphere-editor'); se.innerHTML = '';
      Object.entries(CONFIG.sphereTypes).forEach(([t, info]) => {
        const req = node.requirements?.find(r => r.type === t);
        se.innerHTML += `<div class="sphere-tag" style="background:${info.color}33;color:${info.color}">${t}<input type="number" min="0" max="10" value="${req ? req.count : 0}" data-type="${t}"></div>`;
      });
      const edge = CONFIG.edges.find(e => e.to === node.id);
      document.getElementById('edit-parent').value = edge ? edge.from : 'CORE';
    }

    function addNewNode() {
      const newId = 'NODE_' + Date.now();
      const ring = CONFIG.rings[0]?.id || 'R30';
      const newNode = { id: newId, label: 'æ–°è¦\nãƒãƒ¼ãƒ‰', ring, angleDeg: Math.floor(Math.random() * 360) - 180, state: 'LOCKED', importance: 'STANDARD', shape: 'circle', description: '', effect: '', requirements: [] };
      CONFIG.nodes.push(newNode);
      CONFIG.edges.push({ from: 'CORE', to: newId, type: 'MAIN' });
      selectNode(newId); draw();
    }

    function saveNode() {
      const id = document.getElementById('edit-id').value;
      const node = CONFIG.nodes.find(n => n.id === selectedNodeId);
      if (!node) return;
      if (id !== selectedNodeId) {
        CONFIG.edges.forEach(e => { if (e.from === selectedNodeId) e.from = id; if (e.to === selectedNodeId) e.to = id; });
        node.id = id; selectedNodeId = id;
      }
      node.label = document.getElementById('edit-label').value.replace(/ /g, '\n');
      node.ring = document.getElementById('edit-ring').value;
      node.state = document.getElementById('edit-state').value;
      node.angleDeg = parseInt(document.getElementById('edit-angle').value) || 0;
      node.importance = document.getElementById('edit-importance').value;
      node.shape = document.getElementById('edit-shape').value;
      node.description = document.getElementById('edit-description').value;
      node.effect = document.getElementById('edit-effect').value;
      node.requirements = [];
      document.querySelectorAll('#sphere-editor input').forEach(inp => { const c = parseInt(inp.value); if (c > 0) node.requirements.push({ type: inp.dataset.type, count: c }); });
      const pid = document.getElementById('edit-parent').value;
      const ei = CONFIG.edges.findIndex(e => e.to === node.id);
      if (ei >= 0) CONFIG.edges[ei].from = pid; else CONFIG.edges.push({ from: pid, to: node.id, type: 'MAIN' });
      updateNodeList(); draw();
    }

    function deleteNode() {
      if (!selectedNodeId || selectedNodeId === 'CORE') return alert('COREã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
      if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      CONFIG.nodes = CONFIG.nodes.filter(n => n.id !== selectedNodeId);
      CONFIG.edges = CONFIG.edges.filter(e => e.from !== selectedNodeId && e.to !== selectedNodeId);
      selectedNodeId = null;
      document.getElementById('node-editor').style.display = 'none';
      updateNodeList(); draw();
    }

    function cancelEdit() {
      selectedNodeId = null;
      document.getElementById('node-editor').style.display = 'none';
      updateNodeList(); draw();
    }

    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    function exportData() {
      const data = { rings: CONFIG.rings, nodes: CONFIG.nodes, edges: CONFIG.edges };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sphere-grid-data.json'; a.click();
    }

    function importData() {
      const inp = document.createElement('input'); inp.type = 'file'; inp.accept = '.json';
      inp.onchange = e => {
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const d = JSON.parse(ev.target.result);
            if (d.rings) CONFIG.rings = d.rings;
            if (d.nodes) CONFIG.nodes = d.nodes;
            if (d.edges) CONFIG.edges = d.edges;
            updateRingList(); updateNodeList(); updateRingSelect(); draw();
            alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
          } catch { alert('èª­ã¿è¾¼ã¿å¤±æ•—'); }
        };
        reader.readAsText(e.target.files[0]);
      };
      inp.click();
    }

    function downloadImage() {
      const link = document.createElement('a'); link.download = 'sphere-grid.png'; link.href = canvas.toDataURL('image/png'); link.click();
    }
  </script>
</body>

</html>