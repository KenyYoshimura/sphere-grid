<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WG Sphere Grid - ä¼æ¥­ã‚¹ãƒ•ã‚£ã‚¢ç›¤</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #03060f;
      font-family: 'Outfit', 'Hiragino Sans', sans-serif;
      overflow: hidden;
      color: #fff;
    }

    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    #login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #050812 0%, #0A1628 50%, #051020 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    #login-screen.hidden {
      display: none;
    }

    .login-box {
      background: rgba(10, 22, 40, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(74, 122, 184, 0.3);
      border-radius: 24px;
      padding: 48px 60px;
      text-align: center;
      box-shadow: 0 40px 100px rgba(0, 0, 0, 0.6), 0 0 40px rgba(74, 122, 184, 0.1);
      animation: fadeIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .login-logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: radial-gradient(circle at 30% 30%, #FFE066, #B88A08);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 32px;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
    }

    .login-box h1 {
      color: #FFD700;
      font-size: 24px;
      letter-spacing: 3px;
      margin-bottom: 8px;
    }

    .login-box .subtitle {
      color: #889;
      font-size: 14px;
      margin-bottom: 30px;
    }

    .login-box input[type="password"] {
      width: 100%;
      padding: 14px 20px;
      background: rgba(20, 40, 60, 0.8);
      border: 1px solid rgba(74, 122, 184, 0.3);
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      text-align: center;
      letter-spacing: 4px;
      margin-bottom: 16px;
    }

    .login-box input[type="password"]:focus {
      outline: none;
      border-color: #FFD700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
    }

    .login-box input[type="password"]::placeholder {
      letter-spacing: 0;
      color: #556;
    }

    .login-box button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #B88A08, #FFD700);
      border: none;
      border-radius: 8px;
      color: #000;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }

    .login-box button:hover {
      background: linear-gradient(135deg, #FFD700, #FFE44D);
      box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
    }

    .login-error {
      color: #E64D66;
      font-size: 13px;
      margin-top: 12px;
      min-height: 20px;
    }

    .login-hint {
      color: #556;
      font-size: 11px;
      margin-top: 20px;
    }

    #logout-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(100, 100, 120, 0.3);
      border: 1px solid rgba(100, 100, 120, 0.5);
      color: #889;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      z-index: 100;
    }

    #logout-btn:hover {
      background: rgba(230, 77, 102, 0.3);
      border-color: rgba(230, 77, 102, 0.5);
      color: #E64D66;
    }

    #main-content {
      display: none;
    }

    #main-content.visible {
      display: block;
    }

    #container {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    canvas {
      display: block;
      cursor: default;
    }

    canvas.dragging {
      cursor: grabbing;
    }

    canvas.can-drag {
      cursor: grab;
    }

    #tooltip {
      position: absolute;
      display: none;
      background: rgba(8, 14, 28, 0.96);
      border: 1px solid rgba(74, 122, 184, 0.4);
      border-radius: 12px;
      padding: 16px 20px;
      color: #fff;
      font-size: 12px;
      max-width: 300px;
      pointer-events: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 1px rgba(255, 255, 255, 0.1);
      z-index: 1000;
      backdrop-filter: blur(12px);
    }

    #tooltip h3 {
      color: #FFD700;
      font-size: 15px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    #tooltip .state {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 10px;
      margin-bottom: 10px;
      font-weight: 500;
    }

    #tooltip .state.MASTERED {
      background: rgba(255, 215, 0, 0.2);
      color: #FFD700;
      border: 1px solid rgba(255, 215, 0, 0.3);
    }

    #tooltip .state.UNLOCKED {
      background: rgba(51, 230, 128, 0.2);
      color: #33E680;
      border: 1px solid rgba(51, 230, 128, 0.3);
    }

    #tooltip .state.ELIGIBLE {
      background: rgba(255, 215, 0, 0.15);
      color: #FFD700;
      border: 1px solid rgba(255, 215, 0, 0.25);
    }

    #tooltip .state.LOCKED {
      background: rgba(100, 100, 120, 0.25);
      color: #8899aa;
      border: 1px solid rgba(100, 100, 120, 0.3);
    }

    #tooltip .description {
      color: #aabbcc;
      margin-bottom: 10px;
      line-height: 1.5;
    }

    #tooltip .requirements {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(74, 122, 184, 0.2);
    }

    #tooltip .requirements h4 {
      color: #B88A08;
      font-size: 11px;
      margin-bottom: 6px;
      font-weight: 500;
    }

    #tooltip .sphere-item {
      display: inline-block;
      margin: 3px 6px 3px 0;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
    }

    #tooltip .effect {
      color: #4DCC80;
      margin-top: 10px;
      font-size: 12px;
      padding-top: 10px;
      border-top: 1px solid rgba(74, 122, 184, 0.2);
    }

    /* æƒ…å ±ãƒ‘ãƒãƒ« */
    #legend,
    #gates {
      position: absolute;
      background: rgba(8, 14, 28, 0.92);
      border: 1px solid rgba(74, 122, 184, 0.3);
      border-radius: 16px;
      padding: 20px 24px;
      color: #fff;
      font-size: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(12px);
    }

    #legend {
      top: 20px;
      right: 20px;
      min-width: 240px;
    }

    #gates {
      top: 20px;
      left: 20px;
      max-width: 280px;
    }

    #legend h2,
    #gates h2 {
      color: #FFD700;
      font-size: 15px;
      margin-bottom: 16px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    #legend h3,
    #gates h3 {
      color: #B88A08;
      font-size: 11px;
      margin: 16px 0 10px 0;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    #gates .subtitle {
      color: #8899aa;
      font-size: 12px;
      margin-bottom: 16px;
    }

    #gates ul {
      list-style: none;
      color: #aabbcc;
      line-height: 2;
    }

    #gates li {
      display: flex;
      align-items: center;
    }

    #gates li::before {
      content: "";
      width: 6px;
      height: 6px;
      background: #4A7AB8;
      border-radius: 50%;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin: 8px 0;
    }

    .legend-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .legend-sphere {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 10px;
      flex-shrink: 0;
      box-shadow: 0 0 8px currentColor;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .legend-sphere:hover {
      transform: scale(1.2);
    }

    .legend-text {
      flex: 1;
    }

    .legend-text .label {
      color: #fff;
      font-weight: 500;
    }

    .legend-text .desc {
      color: #8899aa;
      font-size: 10px;
      margin-top: 2px;
    }

    /* ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    #zoom-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(8, 14, 28, 0.9);
      border: 1px solid rgba(74, 122, 184, 0.3);
      border-radius: 12px;
      padding: 8px 16px;
      backdrop-filter: blur(12px);
      z-index: 100;
    }

    #zoom-controls button {
      width: 36px;
      height: 36px;
      background: rgba(74, 122, 184, 0.2);
      border: 1px solid rgba(74, 122, 184, 0.3);
      border-radius: 8px;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #zoom-controls button:hover {
      background: rgba(74, 122, 184, 0.4);
      border-color: rgba(74, 122, 184, 0.5);
    }

    #zoom-controls button:active {
      transform: scale(0.95);
    }

    #zoom-level {
      color: #8899aa;
      font-size: 12px;
      min-width: 48px;
      text-align: center;
      font-weight: 500;
    }

    #zoom-controls .divider {
      width: 1px;
      height: 24px;
      background: rgba(74, 122, 184, 0.3);
      margin: 0 4px;
    }

    /* ç·¨é›†ãƒœã‚¿ãƒ³ */
    #editor-toggle {
      position: absolute;
      bottom: 20px;
      left: 320px;
      background: rgba(255, 215, 0, 0.15);
      border: 1px solid rgba(255, 215, 0, 0.4);
      color: #FFD700;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      backdrop-filter: blur(8px);
      z-index: 100;
    }

    #editor-toggle:hover {
      background: rgba(255, 215, 0, 0.25);
      border-color: rgba(255, 215, 0, 0.6);
    }

    #editor-toggle.active {
      background: rgba(255, 215, 0, 0.3);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
    }

    /* ç·¨é›†ãƒ‘ãƒãƒ« */
    #editor-panel {
      position: absolute;
      top: 0;
      right: -500px;
      width: 500px;
      height: 100vh;
      background: rgba(8, 14, 28, 0.98);
      border-left: 1px solid rgba(74, 122, 184, 0.3);
      padding: 24px;
      overflow-y: auto;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 2000;
      backdrop-filter: blur(20px);
    }

    #editor-panel.open {
      right: 0;
    }

    #editor-panel h2 {
      color: #FFD700;
      font-size: 20px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }

    #editor-panel .close-btn {
      background: rgba(100, 110, 130, 0.3);
      border: none;
      color: #8899aa;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #editor-panel .close-btn:hover {
      background: rgba(230, 77, 102, 0.3);
      color: #E64D66;
    }

    .editor-section {
      margin-bottom: 24px;
      padding: 20px;
      background: rgba(74, 122, 184, 0.08);
      border-radius: 12px;
      border: 1px solid rgba(74, 122, 184, 0.15);
    }

    .editor-section h3 {
      color: #FFD700;
      font-size: 13px;
      margin-bottom: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .editor-section h3::before {
      content: "";
      width: 4px;
      height: 16px;
      background: linear-gradient(180deg, #FFD700, #B88A08);
      border-radius: 2px;
    }

    .node-list {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 12px;
    }

    .node-list::-webkit-scrollbar {
      width: 6px;
    }

    .node-list::-webkit-scrollbar-track {
      background: rgba(74, 122, 184, 0.1);
      border-radius: 3px;
    }

    .node-list::-webkit-scrollbar-thumb {
      background: rgba(74, 122, 184, 0.3);
      border-radius: 3px;
    }

    .node-list-item {
      display: flex;
      align-items: center;
      padding: 12px 14px;
      margin: 6px 0;
      background: rgba(74, 122, 184, 0.1);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid transparent;
    }

    .node-list-item:hover {
      background: rgba(74, 122, 184, 0.2);
    }

    .node-list-item.selected {
      background: rgba(255, 215, 0, 0.15);
      border-color: rgba(255, 215, 0, 0.4);
    }

    .node-list-item .node-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 12px;
      box-shadow: 0 0 8px currentColor;
    }

    .node-list-item .node-name {
      color: #fff;
      flex: 1;
      font-size: 13px;
      font-weight: 500;
    }

    .node-list-item .node-ring {
      color: #8899aa;
      font-size: 11px;
      margin-right: 10px;
      background: rgba(74, 122, 184, 0.2);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .node-list-item .node-state {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 5px;
      font-weight: 500;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      color: #8899aa;
      font-size: 11px;
      margin-bottom: 6px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 14px;
      background: rgba(20, 30, 50, 0.6);
      border: 1px solid rgba(74, 122, 184, 0.25);
      border-radius: 10px;
      color: #fff;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #FFD700;
      background: rgba(20, 30, 50, 0.8);
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
    }

    .form-group select {
      cursor: pointer;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
      line-height: 1.5;
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .sphere-editor {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .sphere-tag {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid transparent;
    }

    .sphere-tag input {
      width: 40px;
      padding: 4px 6px;
      margin-left: 8px;
      text-align: center;
      font-size: 12px;
      border-radius: 6px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .ring-list {
      margin-bottom: 12px;
    }

    .ring-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0;
      padding: 8px;
      background: rgba(74, 122, 184, 0.1);
      border-radius: 6px;
    }

    .ring-item input {
      flex: 1;
    }

    .ring-item .ring-radius {
      width: 70px;
    }

    .ring-item .delete-ring {
      background: rgba(230, 77, 102, 0.3);
      border: none;
      color: #E64D66;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-primary {
      background: #FFD700;
      color: #000;
    }

    .btn-primary:hover {
      background: #FFE44D;
    }

    .btn-secondary {
      background: rgba(74, 122, 184, 0.3);
      color: #fff;
      border: 1px solid rgba(74, 122, 184, 0.5);
    }

    .btn-secondary:hover {
      background: rgba(74, 122, 184, 0.5);
    }

    .btn-danger {
      background: rgba(230, 77, 102, 0.3);
      color: #E64D66;
      border: 1px solid rgba(230, 77, 102, 0.5);
    }

    .btn-danger:hover {
      background: rgba(230, 77, 102, 0.5);
      color: #fff;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 11px;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .drag-hint {
      position: absolute;
      bottom: 60px;
      left: 20px;
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid rgba(255, 215, 0, 0.3);
      color: #FFD700;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      display: none;
    }

    .drag-hint.visible {
      display: block;
    }

    /* ç¾åœ¨ã®æŒ‡æ¨™ãƒ‘ãƒãƒ« */
    #metrics-panel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(8, 14, 28, 0.92);
      border: 1px solid rgba(74, 122, 184, 0.3);
      border-radius: 16px;
      padding: 16px 20px;
      color: #fff;
      font-size: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(12px);
      min-width: 280px;
      z-index: 100;
    }

    #metrics-panel h2 {
      color: #FFD700;
      font-size: 14px;
      margin-bottom: 12px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #metrics-panel .toggle-btn {
      background: none;
      border: none;
      color: #8899aa;
      cursor: pointer;
      font-size: 14px;
    }

    #metrics-panel .toggle-btn:hover {
      color: #FFD700;
    }

    #metrics-panel.collapsed .metrics-content {
      display: none;
    }

    #metrics-panel.collapsed {
      min-width: auto;
    }

    .metrics-content {
      margin-top: 8px;
    }

    .metric-row {
      display: flex;
      align-items: center;
      margin: 8px 0;
      gap: 8px;
    }

    .metric-row label {
      color: #8899aa;
      font-size: 11px;
      min-width: 70px;
    }

    .metric-row input {
      flex: 1;
      padding: 6px 10px;
      background: rgba(20, 30, 50, 0.6);
      border: 1px solid rgba(74, 122, 184, 0.25);
      border-radius: 6px;
      color: #fff;
      font-size: 12px;
      text-align: right;
    }

    .metric-row input:focus {
      outline: none;
      border-color: #FFD700;
    }

    .metric-row .unit {
      color: #8899aa;
      font-size: 11px;
      min-width: 30px;
    }

    .metric-divider {
      height: 1px;
      background: rgba(74, 122, 184, 0.2);
      margin: 12px 0;
    }

    .sphere-inventory {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .sphere-inv-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: rgba(74, 122, 184, 0.1);
      border-radius: 8px;
      font-size: 11px;
    }

    .sphere-inv-item .sphere-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .sphere-inv-item input {
      width: 32px;
      padding: 3px 5px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      color: #fff;
      font-size: 11px;
      text-align: center;
    }

    .metric-status {
      margin-top: 12px;
      padding: 10px;
      background: rgba(74, 122, 184, 0.1);
      border-radius: 8px;
    }

    .metric-status .status-title {
      color: #B88A08;
      font-size: 11px;
      margin-bottom: 6px;
      font-weight: 600;
    }

    .metric-status .status-value {
      font-size: 18px;
      font-weight: 600;
    }

    .metric-status .status-value.good {
      color: #33E680;
    }

    .metric-status .status-value.warning {
      color: #FFD700;
    }

    .metric-status .status-value.bad {
      color: #E64D66;
    }

    #export-section {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid rgba(74, 122, 184, 0.2);
    }

    #export-section h3 {
      color: #B88A08;
      font-size: 14px;
      margin-bottom: 12px;
    }
  </style>
</head>

<body>
  <div id="login-screen">
    <div class="login-box">
      <div class="login-logo">âš¡</div>
      <h1>WONDERFUL GROWTH</h1>
      <div class="subtitle">ä¼æ¥­ã‚¹ãƒ•ã‚£ã‚¢ç›¤ - ç¤¾å†…é™å®š</div>
      <input type="password" id="password-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="off">
      <button onclick="attemptLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div class="login-error" id="login-error"></div>
      <div class="login-hint">â€» ç¤¾å†…ãƒ¡ãƒ³ãƒãƒ¼ç”¨ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼</div>
    </div>
  </div>

  <div id="main-content">
    <div id="container"><canvas id="canvas"></canvas></div>
    <div id="tooltip"></div>
    <button id="logout-btn" onclick="logout()">ğŸ”“ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

    <div id="gates">
      <h2>WONDERFUL GROWTH</h2>
      <div class="subtitle">ä¼æ¥­ã‚¹ãƒ•ã‚£ã‚¢ç›¤</div>
      <h3>åŸºç›¤ã‚²ãƒ¼ãƒˆé”æˆæ¡ä»¶</h3>
      <ul>
        <li>ç¾é é‡‘ï¼šå›ºå®šè²»4ãƒ¶æœˆåˆ†ä»¥ä¸Š</li>
        <li>ç²—åˆ©ç‡ï¼š40%ä»¥ä¸Š</li>
        <li>ç¨¼åƒç‡ï¼š100%</li>
        <li>æ¡ç”¨ï¼šå¥‘ç´„æ¸ˆã¿Backlogã®ã¿</li>
        <li>ã‚ªãƒ•ã‚£ã‚¹ï¼šè³ƒæ–™ â‰¤ ç²—åˆ©15%</li>
      </ul>
    </div>

    <div id="legend">
      <h2>ãƒãƒ¼ãƒ‰çŠ¶æ…‹</h2>
      <div class="legend-item">
        <div class="legend-dot"
          style="background: radial-gradient(circle at 30% 30%, #FFF5CC, #FFD700); box-shadow: 0 0 14px #FFD700;"></div>
        <div class="legend-text"><span class="label">å®šç€</span><br><span class="desc">ç¿’å¾—å®Œäº†ãƒ»å®šç€æ¸ˆã¿</span></div>
      </div>
      <div class="legend-item">
        <div class="legend-dot"
          style="background: radial-gradient(circle at 30% 30%, #66E699, #33E680); box-shadow: 0 0 12px #33E680;"></div>
        <div class="legend-text"><span class="label">è§£æ”¾æ¸ˆ</span><br><span class="desc">ç¿’å¾—ä¸­ãƒ»å®Ÿæ–½ä¸­</span></div>
      </div>
      <div class="legend-item">
        <div class="legend-dot"
          style="background: radial-gradient(circle at 30% 30%, #FFE066, #FFD700); box-shadow: 0 0 10px rgba(255,215,0,0.6);">
        </div>
        <div class="legend-text"><span class="label">è§£æ”¾å¯</span><br><span class="desc">æ¡ä»¶ã‚¯ãƒªã‚¢ãƒ»è§£æ”¾å¯èƒ½</span></div>
      </div>
      <div class="legend-item">
        <div class="legend-dot"
          style="background: radial-gradient(circle at 30% 30%, #3A3E48, #2A2E38); border: 1px solid #4A4E58;"></div>
        <div class="legend-text"><span class="label">æœªè§£æ”¾</span><br><span class="desc">æ¡ä»¶æœªé”æˆ</span></div>
      </div>
      <h3>å¿…è¦ã‚¹ãƒ•ã‚£ã‚¢</h3>
      <div class="legend-item" onmouseenter="hoveredSphereType='äººæ';draw()"
        onmouseleave="hoveredSphereType=null;draw()">
        <div class="legend-sphere" style="background: #3399E6; color: #3399E6;"></div>
        <div class="legend-text"><span class="label">äººæ</span></div>
      </div>
      <div class="legend-item" onmouseenter="hoveredSphereType='è³‡é‡‘';draw()"
        onmouseleave="hoveredSphereType=null;draw()">
        <div class="legend-sphere" style="background: #E6B333; color: #E6B333;"></div>
        <div class="legend-text"><span class="label">è³‡é‡‘</span></div>
      </div>
      <div class="legend-item" onmouseenter="hoveredSphereType='å®Ÿç¸¾';draw()"
        onmouseleave="hoveredSphereType=null;draw()">
        <div class="legend-sphere" style="background: #4DCC80; color: #4DCC80;"></div>
        <div class="legend-text"><span class="label">å®Ÿç¸¾</span></div>
      </div>
      <div class="legend-item" onmouseenter="hoveredSphereType='æ™‚é–“';draw()"
        onmouseleave="hoveredSphereType=null;draw()">
        <div class="legend-sphere" style="background: #9966CC; color: #9966CC;"></div>
        <div class="legend-text"><span class="label">æ™‚é–“</span></div>
      </div>
      <div class="legend-item" onmouseenter="hoveredSphereType='ä¿¡é ¼';draw()"
        onmouseleave="hoveredSphereType=null;draw()">
        <div class="legend-sphere" style="background: #E68033; color: #E68033;"></div>
        <div class="legend-text"><span class="label">ä¿¡é ¼</span></div>
      </div>
      <div class="legend-item" onmouseenter="hoveredSphereType='æŠ€è¡“';draw()"
        onmouseleave="hoveredSphereType=null;draw()">
        <div class="legend-sphere" style="background: #66B3E6; color: #66B3E6;"></div>
        <div class="legend-text"><span class="label">æŠ€è¡“</span></div>
      </div>
    </div>

    <div id="metrics-panel">
      <h2>ç¾åœ¨ã®æŒ‡æ¨™ <button class="toggle-btn" onclick="toggleMetrics()">â–¼</button></h2>
      <div class="metrics-content">
        <div class="metric-row">
          <label>å¹´å•†</label>
          <input type="number" id="metric-revenue" value="1500" onchange="updateMetrics()">
          <span class="unit">ä¸‡å††</span>
        </div>
        <div class="metric-row">
          <label>å¾“æ¥­å“¡æ•°</label>
          <input type="number" id="metric-employees" value="2" onchange="updateMetrics()">
          <span class="unit">å</span>
        </div>
        <div class="metric-row">
          <label>ç²—åˆ©ç‡</label>
          <input type="number" id="metric-margin" value="45" onchange="updateMetrics()">
          <span class="unit">%</span>
        </div>
        <div class="metric-row">
          <label>ç¾é é‡‘</label>
          <input type="number" id="metric-cash" value="800" onchange="updateMetrics()">
          <span class="unit">ä¸‡å††</span>
        </div>
        <div class="metric-divider"></div>
        <div style="color: #B88A08; font-size: 11px; margin-bottom: 8px; font-weight: 600;">ä¿æœ‰ã‚¹ãƒ•ã‚£ã‚¢</div>
        <div class="sphere-inventory" id="sphere-inventory"></div>
        <div class="metric-status">
          <div class="status-title">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸</div>
          <div class="status-value" id="current-stage">-</div>
        </div>
      </div>
    </div>


    <button id="editor-toggle" onclick="toggleEditor()">ğŸ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
    <div id="drag-hint" class="drag-hint">ğŸ–±ï¸ ãƒãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç§»å‹•ã§ãã¾ã™</div>

    <div id="editor-panel">
      <h2>ã‚¹ãƒ•ã‚£ã‚¢ç›¤ã‚¨ãƒ‡ã‚£ã‚¿<button class="close-btn" onclick="toggleEditor()">Ã—</button></h2>

      <div class="editor-section">
        <h3>ãƒªãƒ³ã‚°ç®¡ç†</h3>
        <div class="ring-list" id="ring-list"></div>
        <button class="btn btn-secondary btn-small" onclick="addNewRing()">+ ãƒªãƒ³ã‚°è¿½åŠ </button>
      </div>

      <div class="editor-section">
        <h3>ãƒãƒ¼ãƒ‰ä¸€è¦§</h3>
        <div class="node-list" id="node-list"></div>
        <button class="btn btn-secondary btn-small" onclick="addNewNode()">+ ãƒãƒ¼ãƒ‰è¿½åŠ </button>
      </div>

      <div class="editor-section" id="node-editor" style="display: none;">
        <h3>ãƒãƒ¼ãƒ‰ç·¨é›† <span style="font-size:11px;color:#889;">(ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚‚ç§»å‹•å¯)</span></h3>
        <div class="form-row">
          <div class="form-group"><label>ID</label><input type="text" id="edit-id"></div>
          <div class="form-group"><label>ãƒªãƒ³ã‚°</label><select id="edit-ring"></select></div>
        </div>
        <div class="form-group"><label>ãƒ©ãƒ™ãƒ«ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã§æ”¹è¡Œï¼‰</label><input type="text" id="edit-label"></div>
        <div class="form-row">
          <div class="form-group"><label>çŠ¶æ…‹</label>
            <select id="edit-state">
              <option value="LOCKED">æœªè§£æ”¾</option>
              <option value="ELIGIBLE">è§£æ”¾å¯</option>
              <option value="UNLOCKED">è§£æ”¾æ¸ˆ</option>
              <option value="MASTERED">å®šç€</option>
            </select>
          </div>
          <div class="form-group"><label>è§’åº¦ (åº¦)</label><input type="number" id="edit-angle" min="-180" max="180"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>é‡è¦åº¦</label>
            <select id="edit-importance">
              <option value="STANDARD">æ¨™æº–</option>
              <option value="MAJOR">é‡è¦</option>
              <option value="MINOR">å°</option>
            </select>
          </div>
          <div class="form-group"><label>å½¢çŠ¶</label>
            <select id="edit-shape">
              <option value="circle">å††</option>
              <option value="hexagon">å…­è§’å½¢</option>
              <option value="diamond">è±å½¢</option>
              <option value="octagon">å…«è§’å½¢</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label>èª¬æ˜</label><textarea id="edit-description"></textarea></div>
        <div class="form-group"><label>åŠ¹æœ</label><input type="text" id="edit-effect"></div>
        <div class="form-group"><label>å¿…è¦ã‚¹ãƒ•ã‚£ã‚¢</label>
          <div class="sphere-editor" id="sphere-editor"></div>
        </div>
        <div class="form-group"><label>æ¥ç¶šå…ƒ</label><select id="edit-parent"></select></div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveNode()">ä¿å­˜</button>
          <button class="btn btn-danger" onclick="deleteNode()">å‰Šé™¤</button>
          <button class="btn btn-secondary" onclick="cancelEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>

      <div id="export-section">
        <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
        <div class="btn-group">
          <button class="btn btn-secondary btn-small" onclick="exportData()">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button class="btn btn-secondary btn-small" onclick="importData()">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <button class="btn btn-secondary btn-small" onclick="downloadImage()">ğŸ–¼ï¸ ç”»åƒä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // èªè¨¼
    const ACCESS_PASSWORD = 'wg2024';
    const AUTH_KEY = 'wg_sphere_auth';
    const AUTH_EXPIRY_DAYS = 7;

    function checkAuth() {
      const d = localStorage.getItem(AUTH_KEY);
      if (!d) return false;
      try {
        const { hash, expiry } = JSON.parse(d);
        if (Date.now() > expiry) { localStorage.removeItem(AUTH_KEY); return false; }
        return hash === simpleHash(ACCESS_PASSWORD);
      } catch { return false; }
    }
    function simpleHash(s) { let h = 0; for (let i = 0; i < s.length; i++) { h = ((h << 5) - h) + s.charCodeAt(i); h &= h; } return h.toString(36); }
    function attemptLogin() {
      const inp = document.getElementById('password-input');
      if (inp.value === ACCESS_PASSWORD) {
        localStorage.setItem(AUTH_KEY, JSON.stringify({ hash: simpleHash(ACCESS_PASSWORD), expiry: Date.now() + AUTH_EXPIRY_DAYS * 86400000 }));
        showMainContent();
      } else { document.getElementById('login-error').textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'; inp.value = ''; inp.focus(); }
    }
    function logout() { if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem(AUTH_KEY); location.reload(); } }
    function showMainContent() { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('main-content').classList.add('visible'); initApp(); }
    document.getElementById('password-input').addEventListener('keypress', e => { if (e.key === 'Enter') attemptLogin(); });
    if (checkAuth()) showMainContent(); else document.getElementById('password-input').focus();

    // CONFIG
    let CONFIG = {
      width: 1920, height: 1080,
      rings: [
        { id: "R30", label: "å¹´å•† 3,000ä¸‡", radius: 180 },
        { id: "R60", label: "å¹´å•† 6,000ä¸‡", radius: 300 },
        { id: "R100", label: "å¹´å•† 1å„„", radius: 420 },
      ],
      sphereTypes: {
        "äººæ": { color: "#3399E6" }, "è³‡é‡‘": { color: "#E6B333" }, "å®Ÿç¸¾": { color: "#4DCC80" },
        "æ™‚é–“": { color: "#9966CC" }, "ä¿¡é ¼": { color: "#E68033" }, "æŠ€è¡“": { color: "#66B3E6" },
      },
      nodes: [
        { id: "CORE", label: "WG\nCORE", ring: "CORE", angleDeg: 0, state: "MASTERED", importance: "MAJOR", shape: "octagon", sizeMultiplier: 1.4, description: "ä¼æ¥­ã®æ ¸å¿ƒ", effect: "å…¨ãƒãƒ¼ãƒ‰è§£æ”¾", requirements: [] },
        { id: "HIRE_3", label: "æ¡ç”¨\nã€œ3å", ring: "R30", angleDeg: -45, state: "ELIGIBLE", importance: "STANDARD", shape: "circle", description: "æœ€åˆã®æ¡ç”¨", effect: "ã‚­ãƒ£ãƒ‘+30%", requirements: [{ type: "è³‡é‡‘", count: 2 }, { type: "å®Ÿç¸¾", count: 1 }] },
        { id: "OFFICE_15", label: "ã‚ªãƒ•ã‚£ã‚¹\nè³ƒæ–™â‰¤15%", ring: "R30", angleDeg: 15, state: "ELIGIBLE", importance: "STANDARD", shape: "diamond", description: "é©æ­£ã‚³ã‚¹ãƒˆ", effect: "å›ºå®šè²»æœ€é©åŒ–", requirements: [{ type: "è³‡é‡‘", count: 1 }] },
        { id: "PRODUCTIZE", label: "å‹åŒ–\nç ”ä¿®å•†å“", ring: "R30", angleDeg: 75, state: "ELIGIBLE", importance: "MAJOR", shape: "hexagon", sizeMultiplier: 1.15, description: "ã‚µãƒ¼ãƒ“ã‚¹æ¨™æº–åŒ–", effect: "å†ç¾æ€§+50%", requirements: [{ type: "æŠ€è¡“", count: 2 }, { type: "æ™‚é–“", count: 1 }] },
        { id: "BACKOFFICE", label: "ãƒãƒƒã‚¯\nã‚ªãƒ•ã‚£ã‚¹", ring: "R30", angleDeg: 150, state: "ELIGIBLE", importance: "STANDARD", shape: "circle", description: "ç®¡ç†åŸºç›¤æ•´å‚™", effect: "ç®¡ç†åŠ¹ç‡+20%", requirements: [{ type: "è³‡é‡‘", count: 1 }, { type: "äººæ", count: 1 }] },
        { id: "WELFARE", label: "ç¦åˆ©åšç”Ÿ\nå°å…¥", ring: "R60", angleDeg: -60, state: "LOCKED", importance: "STANDARD", shape: "circle", description: "æº€è¶³åº¦å‘ä¸Š", effect: "å®šç€ç‡+15%", requirements: [{ type: "è³‡é‡‘", count: 2 }, { type: "ä¿¡é ¼", count: 1 }] },
        { id: "HIRE_MORE", label: "æ¡ç”¨\nè¿½åŠ ", ring: "R60", angleDeg: -15, state: "LOCKED", importance: "MAJOR", shape: "circle", sizeMultiplier: 1.15, description: "äººæç¢ºä¿", effect: "ã‚­ãƒ£ãƒ‘+50%", requirements: [{ type: "è³‡é‡‘", count: 3 }, { type: "äººæ", count: 1 }, { type: "å®Ÿç¸¾", count: 2 }] },
        { id: "SEC_PREP", label: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£\nèªè¨¼æº–å‚™", ring: "R60", angleDeg: 45, state: "LOCKED", importance: "STANDARD", shape: "diamond", description: "èªè¨¼æº–å‚™", effect: "å¤§ä¼æ¥­å¯¾å¿œ", requirements: [{ type: "æŠ€è¡“", count: 2 }, { type: "æ™‚é–“", count: 2 }] },
        { id: "SALES_PROCESS", label: "å–¶æ¥­\nãƒ—ãƒ­ã‚»ã‚¹", ring: "R60", angleDeg: 115, state: "LOCKED", importance: "MAJOR", shape: "hexagon", sizeMultiplier: 1.15, description: "å–¶æ¥­ä½“ç³»åŒ–", effect: "å—æ³¨åŠ¹ç‡+40%", requirements: [{ type: "å®Ÿç¸¾", count: 2 }, { type: "æŠ€è¡“", count: 1 }] },
        { id: "NEW_BIZ", label: "æ–°è¦äº‹æ¥­\nÃ—1", ring: "R100", angleDeg: -30, state: "LOCKED", importance: "MAJOR", shape: "octagon", sizeMultiplier: 1.2, description: "æ–°é ˜åŸŸé€²å‡º", effect: "åç›Šå¤šè§’åŒ–", requirements: [{ type: "è³‡é‡‘", count: 5 }, { type: "äººæ", count: 2 }, { type: "å®Ÿç¸¾", count: 3 }] },
        { id: "FUNCTION_SPLIT", label: "å°‚ä»»æ©Ÿèƒ½\nåˆ†é›¢", ring: "R100", angleDeg: 30, state: "LOCKED", importance: "STANDARD", shape: "circle", description: "å°‚ä»»ä½“åˆ¶", effect: "å°‚é–€æ€§æ·±åŒ–", requirements: [{ type: "äººæ", count: 3 }, { type: "è³‡é‡‘", count: 2 }] },
        { id: "SEC_GET", label: "èªè¨¼\næœ¬å–å¾—", ring: "R100", angleDeg: 90, state: "LOCKED", importance: "MAJOR", shape: "diamond", sizeMultiplier: 1.15, description: "èªè¨¼å–å¾—", effect: "å¤§å‹æ¡ˆä»¶ç²å¾—", requirements: [{ type: "æŠ€è¡“", count: 3 }, { type: "æ™‚é–“", count: 3 }, { type: "è³‡é‡‘", count: 2 }] },
        { id: "LEAD_DEV", label: "ãƒªãƒ¼ãƒ‰\nè‚²æˆ", ring: "R100", angleDeg: 160, state: "LOCKED", importance: "MAJOR", shape: "circle", sizeMultiplier: 1.15, description: "ãƒªãƒ¼ãƒ€ãƒ¼è‚²æˆ", effect: "æŒç¶šå¯èƒ½æ€§", requirements: [{ type: "äººæ", count: 2 }, { type: "æ™‚é–“", count: 3 }, { type: "ä¿¡é ¼", count: 2 }] },
      ],
      edges: [
        { from: "CORE", to: "HIRE_3", type: "MAIN" }, { from: "CORE", to: "OFFICE_15", type: "MAIN" },
        { from: "CORE", to: "PRODUCTIZE", type: "MAIN" }, { from: "CORE", to: "BACKOFFICE", type: "MAIN" },
        { from: "HIRE_3", to: "WELFARE", type: "OPTIONAL" }, { from: "HIRE_3", to: "HIRE_MORE", type: "MAIN" },
        { from: "HIRE_MORE", to: "FUNCTION_SPLIT", type: "MAIN" }, { from: "FUNCTION_SPLIT", to: "LEAD_DEV", type: "MAIN" },
        { from: "PRODUCTIZE", to: "SALES_PROCESS", type: "MAIN" }, { from: "SALES_PROCESS", to: "NEW_BIZ", type: "MAIN" },
        { from: "SALES_PROCESS", to: "SEC_PREP", type: "OPTIONAL" }, { from: "SEC_PREP", to: "SEC_GET", type: "MAIN" },
        { from: "BACKOFFICE", to: "SEC_PREP", type: "CROSS_DOMAIN" },
      ],
      nodeSizes: { MAJOR: 55, STANDARD: 45, MINOR: 35 }
    };

    let canvas, ctx, tooltip;
    let baseScale = 1, userZoom = 1, panX = 0, panY = 0;
    let cx, cy;
    let nodePositions = [];
    let selectedNodeId = null;
    let hoveredSphereType = null;
    let highlightedPathNodes = new Set();
    let isEditorOpen = false;
    let isDragging = false;
    let isPanning = false;
    let dragNode = null;
    let lastPanPos = null;

    function getScale() { return baseScale * userZoom; }

    function initApp() {
      canvas = document.getElementById('canvas'); ctx = canvas.getContext('2d'); tooltip = document.getElementById('tooltip');
      window.addEventListener('resize', resize); canvas.addEventListener('mousemove', handleMouseMove); canvas.addEventListener('mousedown', handleMouseDown);
      canvas.addEventListener('mouseup', handleMouseUp); canvas.addEventListener('mouseleave', handleMouseLeave); canvas.addEventListener('wheel', handleWheel, { passive: false });
      resize(); updateMetrics();
      setupLegendInteractions(); // Add Legend Listeners
      requestAnimationFrame(animate);
    }

    function setupLegendInteractions() {
      document.querySelectorAll('.legend-item').forEach(item => {
        const label = item.querySelector('.legend-text .label');
        if (label && CONFIG.sphereTypes[label.textContent]) {
          item.style.cursor = 'pointer';
          item.addEventListener('mouseenter', () => { hoveredSphereType = label.textContent; draw(); });
          item.addEventListener('mouseleave', () => { hoveredSphereType = null; draw(); });
        }
      });
    }

    function animate() { draw(); requestAnimationFrame(animate); }

    function resize() {
      const dpr = window.devicePixelRatio || 1, w = window.innerWidth, h = window.innerHeight;
      canvas.width = w * dpr; canvas.height = h * dpr; canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0); baseScale = Math.min(w / CONFIG.width, h / CONFIG.height) * 0.9; cx = w / 2; cy = h / 2;
    }

    function toggleMetrics() { const p = document.getElementById('metrics-panel'); p.classList.toggle('collapsed'); const btn = p.querySelector('.toggle-btn'); btn.textContent = p.classList.contains('collapsed') ? 'â–²' : 'â–¼'; }

    function updateMetrics() {
      const revenue = +document.getElementById('metric-revenue').value, employees = +document.getElementById('metric-employees').value, margin = +document.getElementById('metric-margin').value, cash = +document.getElementById('metric-cash').value;
      const inventory = { 'äººæ': Math.max(0, employees - 1), 'è³‡é‡‘': Math.floor(cash / 200), 'å®Ÿç¸¾': Math.floor(revenue / 500), 'æ™‚é–“': Math.min(5, Math.floor(revenue / 1000) + 1), 'ä¿¡é ¼': Math.floor(margin / 10), 'æŠ€è¡“': Math.floor(revenue / 800) };
      const invEl = document.getElementById('sphere-inventory'); invEl.innerHTML = '';
      Object.entries(inventory).forEach(([type, count]) => { const color = CONFIG.sphereTypes[type]?.color || '#888'; invEl.innerHTML += `<div class="sphere-inv-item"><div class="sphere-dot" style="background:${color}; box-shadow:0 0 8px ${color}"></div><span style="font-size:10px; color:#8899aa">${type}</span><input type="number" value="${count}" readonly></div>`; });
      const stageEl = document.getElementById('current-stage'); stageEl.className = 'status-value'; let stage = "å‰µæ¥­æœŸ (Seed)";
      if (revenue >= 10000) { stage = "æ‹¡å¤§æœŸ (Expansion)"; stageEl.classList.add('good'); } else if (revenue >= 3000) { stage = "æˆé•·æœŸ (Growth)"; stageEl.classList.add('good'); } else if (revenue >= 1000) { stage = "ç«‹ä¸Šã’æœŸ (Startup)"; stageEl.classList.add('warning'); } else { stageEl.classList.add('bad'); } stageEl.textContent = stage;
    }

    function draw() {
      if (!ctx) return;
      try {
        const w = canvas.width / (window.devicePixelRatio || 1), h = canvas.height / (window.devicePixelRatio || 1);
        const grd = ctx.createRadialGradient(cx + panX, cy + panY, 0, cx + panX, cy + panY, Math.max(w, h)); grd.addColorStop(0, '#0a1628'); grd.addColorStop(1, '#03060f'); ctx.fillStyle = grd; ctx.fillRect(0, 0, w, h);
        drawStars(w, h); drawGlow(); drawRings(); drawEdges(); nodePositions = [];
        // Sort once or handle visibility elsewhere. Ideally don't sort every frame.
        // For now, simpler iteration. CORE usually comes first in list, so we might want to draw it last?
        // Let's just draw in order.
        CONFIG.nodes.forEach(n => { const p = drawNode(n); nodePositions.push({ id: n.id, ...p }); });
        if (hoveredSphereType) drawSphereConnections();
      } catch (e) {
        console.error('Draw error:', e);
      }
    }

    function drawStars(w, h) {
      const time = Date.now() * 0.0005; let seed = 54321; const rnd = () => { seed = (seed * 1103515245 + 12345) & 0x7fffffff; return seed / 0x7fffffff; };
      [[150, 0.5, 1.2, 0.1, 0.3], [70, 1, 2, 0.2, 0.5], [30, 2, 4, 0.4, 0.8]].forEach(([c, s1, s2, o1, o2], idx) => {
        for (let i = 0; i < c; i++) {
          const rx = rnd(), ry = rnd(), pScale = 1 + idx * 0.2;
          const x = (rx * w + Math.sin(time * pScale + rx * 10) * 10) % w, y = (ry * h + Math.cos(time * pScale + ry * 10) * 10) % h;
          if (Math.sqrt((x - (cx + panX)) ** 2 + (y - (cy + panY)) ** 2) < 120 * getScale()) continue;
          const sz = s1 + rnd() * (s2 - s1), op = o1 + rnd() * (o2 - o1) * (0.5 + 0.5 * Math.sin(time + rx * 20));
          ctx.beginPath(); ctx.arc(x, y, sz, 0, Math.PI * 2); ctx.fillStyle = `rgba(255,255,255,${op})`; ctx.fill();
        }
      });
    }

    function drawGlow() {
      const scale = getScale(); const r = 600 * scale;
      const g = ctx.createRadialGradient(cx + panX, cy + panY, 0, cx + panX, cy + panY, r);
      g.addColorStop(0, 'rgba(30,56,106,0.5)'); g.addColorStop(0.5, 'rgba(20,36,66,0.2)'); g.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.beginPath(); ctx.arc(cx + panX, cy + panY, r, 0, Math.PI * 2); ctx.fillStyle = g; ctx.fill();
    }

    function drawRings() {
      const scale = getScale(); CONFIG.rings.forEach((ring, i) => {
        const r = ring.radius * scale; const intensity = 1 - i * 0.15;
        // Outer Glow Layer
        ctx.beginPath(); ctx.arc(cx + panX, cy + panY, r, 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(74,122,184,${0.2 * intensity})`; ctx.lineWidth = 12 * scale; ctx.stroke();
        // Inner Core Line Layer
        ctx.beginPath(); ctx.arc(cx + panX, cy + panY, r, 0, Math.PI * 2);
        ctx.strokeStyle = `rgba(100,160,230,${0.6 + 0.2 * intensity})`; ctx.lineWidth = 2 * scale; ctx.stroke();
        // Label
        ctx.font = `600 ${Math.max(10, 11 * scale)}px "Outfit", sans-serif`;
        ctx.fillStyle = `rgba(200,225,255,${0.6 + 0.3 * intensity})`; ctx.textAlign = 'center';
        ctx.fillText(ring.label.toUpperCase(), cx + panX, cy + panY - r - 12 * scale);
      });
    }

    function drawEdges() {
      const scale = getScale(); const time = Date.now() * 0.002;
      CONFIG.edges.forEach(edge => {
        const from = CONFIG.nodes.find(n => n.id === edge.from), to = CONFIG.nodes.find(n => n.id === edge.to); if (!from || !to) return;
        const p1 = getNodePos(from), p2 = getNodePos(to), isPath = highlightedPathNodes.has(from.id) && highlightedPathNodes.has(to.id);
        const isMain = edge.type === 'MAIN', isCross = edge.type === 'CROSS_DOMAIN';

        // Background line (Thick)
        ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
        ctx.strokeStyle = isPath ? 'rgba(255,215,0,0.15)' : `rgba(58,96,144,${isMain ? 0.3 : 0.15})`;
        ctx.lineWidth = (isMain ? 10 : 6) * scale; ctx.lineCap = 'round'; ctx.stroke();

        // Core line (Sharp)
        ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
        if (isPath) {
          ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 3 * scale; ctx.shadowBlur = 10; ctx.shadowColor = '#FFD700';
        } else {
          ctx.strokeStyle = isCross ? 'rgba(184,138,8,0.6)' : `rgba(74,122,184,${isMain ? 0.8 : 0.5})`;
          ctx.lineWidth = (isMain ? 2.5 : 1.2) * scale; ctx.shadowBlur = 0;
        }
        if (edge.type === 'OPTIONAL') ctx.setLineDash([5, 5]); else ctx.setLineDash([]);
        ctx.stroke(); ctx.setLineDash([]); ctx.shadowBlur = 0;

        // Animate particles on main path
        if (isMain && !isPath) {
          const dist = Math.sqrt((p2.x - p1.x) ** 2 + (p2.y - p1.y) ** 2);
          const dotPos = (time % 1) * dist; const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
          const dx = p1.x + Math.cos(angle) * dotPos, dy = p1.y + Math.sin(angle) * dotPos;
          ctx.beginPath(); ctx.arc(dx, dy, 1.5 * scale, 0, Math.PI * 2); ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.fill();
        }
      });
    }

    function drawNode(node) {
      const scale = getScale(), pos = getNodePos(node), baseSize = CONFIG.nodeSizes[node.importance] || 45, size = baseSize * (node.sizeMultiplier || 1) * scale;
      const isSelected = selectedNodeId === node.id, isPath = highlightedPathNodes.has(node.id), hasSph = hoveredSphereType && node.requirements?.some(r => r.type === hoveredSphereType);
      const time = Date.now() * 0.003;

      // Outer Glow & Pulsing
      if (node.state !== 'LOCKED' || isPath || hasSph) {
        ctx.beginPath(); ctx.arc(pos.x, pos.y, size * (1.25 + Math.sin(time) * 0.05), 0, Math.PI * 2);
        const g = ctx.createRadialGradient(pos.x, pos.y, size * 0.7, pos.x, pos.y, size * 1.5);
        let gc = node.state === 'MASTERED' ? '#FFD700' : (node.state === 'UNLOCKED' ? '#33E680' : '#FFD700');
        if (hasSph) gc = CONFIG.sphereTypes[hoveredSphereType].color;
        g.addColorStop(0, gc + '55'); g.addColorStop(1, gc + '00'); ctx.fillStyle = g; ctx.fill();
      }

      // Node Body
      ctx.beginPath();
      if (node.shape === 'hexagon') drawPoly(pos.x, pos.y, size, 6, Math.PI / 2);
      else if (node.shape === 'diamond') drawPoly(pos.x, pos.y, size, 4, 0);
      else if (node.shape === 'octagon') drawPoly(pos.x, pos.y, size, 8, Math.PI / 8);
      else ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);

      const baseFill = node.state === 'LOCKED' ? '#2A2E38' : (node.state === 'MASTERED' ? '#B88A08' : (node.state === 'UNLOCKED' ? '#146B3A' : '#B88A08'));
      const grd = ctx.createRadialGradient(pos.x - size * 0.3, pos.y - size * 0.3, size * 0.1, pos.x, pos.y, size * 1.1);
      grd.addColorStop(0, lighten(baseFill, 0.4)); grd.addColorStop(0.5, baseFill); grd.addColorStop(1, darken(baseFill, 0.4));
      ctx.fillStyle = grd; ctx.fill();

      // Reflections (Gloss)
      ctx.save();
      ctx.beginPath();
      const clipSize = size * 0.98;
      if (node.shape === 'hexagon') drawPoly(pos.x, pos.y, clipSize, 6, Math.PI / 2); else if (node.shape === 'diamond') drawPoly(pos.x, pos.y, clipSize, 4, 0); else if (node.shape === 'octagon') drawPoly(pos.x, pos.y, clipSize, 8, Math.PI / 8); else ctx.arc(pos.x, pos.y, clipSize, 0, Math.PI * 2);
      ctx.clip();

      // Top Highlight
      const glossGrd = ctx.createLinearGradient(pos.x, pos.y - size, pos.x, pos.y);
      glossGrd.addColorStop(0, 'rgba(255,255,255,0.4)'); glossGrd.addColorStop(0.5, 'rgba(255,255,255,0.05)'); glossGrd.addColorStop(1, 'rgba(255,255,255,0)');
      ctx.beginPath(); ctx.ellipse(pos.x, pos.y - size * 0.4, size * 0.7, size * 0.4, 0, 0, Math.PI * 2);
      ctx.fillStyle = glossGrd; ctx.fill();

      // Bottom Reflection
      const botGlow = ctx.createRadialGradient(pos.x, pos.y + size * 0.8, 0, pos.x, pos.y + size * 0.8, size * 0.5);
      botGlow.addColorStop(0, 'rgba(255,255,255,0.2)'); botGlow.addColorStop(1, 'rgba(255,255,255,0)');
      ctx.beginPath(); ctx.ellipse(pos.x, pos.y + size * 0.7, size * 0.5, size * 0.2, 0, 0, Math.PI * 2);
      ctx.fillStyle = botGlow; ctx.fill();

      ctx.restore();

      // Border
      ctx.beginPath();
      if (node.shape === 'hexagon') drawPoly(pos.x, pos.y, size, 6, Math.PI / 2); else if (node.shape === 'diamond') drawPoly(pos.x, pos.y, size, 4, 0); else if (node.shape === 'octagon') drawPoly(pos.x, pos.y, size, 8, Math.PI / 8); else ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
      ctx.strokeStyle = isSelected ? '#fff' : (node.state === 'LOCKED' ? '#4A4E58' : '#FFD700');
      ctx.lineWidth = (isSelected || node.state === 'MASTERED' ? 3 : 1.5) * scale;
      if (isSelected) { ctx.shadowBlur = 10; ctx.shadowColor = '#fff'; }
      ctx.stroke(); ctx.shadowBlur = 0;

      // Text
      ctx.font = `600 ${Math.max(8, 11 * scale)}px "Outfit", sans-serif`;
      ctx.fillStyle = node.state === 'LOCKED' ? '#8899aa' : '#fff';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      const lines = node.label.split('\n'), lh = 14 * scale, startY = pos.y - ((lines.length - 1) * lh) / 2; lines.forEach((l, i) => ctx.fillText(l, pos.x, startY + i * lh));

      if (node.state === 'LOCKED') { ctx.font = `${10 * scale}px serif`; ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.fillText('ğŸ”’', pos.x + size * 0.7, pos.y - size * 0.7); }
      return { x: pos.x, y: pos.y, size };
    }

    function getNodePos(node) {
      const radius = (CONFIG.rings.find(r => r.id === node.ring)?.radius || 0) * getScale(), angle = (node.angleDeg || 0) * Math.PI / 180;
      if (node.id === 'CORE') return { x: cx + panX, y: cy + panY };
      return { x: cx + panX + Math.cos(angle) * radius, y: cy + panY + Math.sin(angle) * radius };
    }

    function drawPoly(x, y, r, sides, rot = 0) { ctx.moveTo(x + r * Math.cos(rot), y + r * Math.sin(rot)); for (let i = 1; i <= sides; i++) { const a = rot + (i * 2 * Math.PI) / sides; ctx.lineTo(x + r * Math.cos(a), y + r * Math.sin(a)); } ctx.closePath(); }

    function drawSphereConnections() {
      const color = CONFIG.sphereTypes[hoveredSphereType].color, w = canvas.width / (window.devicePixelRatio || 1);
      nodePositions.filter(p => CONFIG.nodes.find(n => n.id === p.id)?.requirements?.some(r => r.type === hoveredSphereType)).forEach(p => {
        ctx.beginPath(); ctx.setLineDash([5, 5]); ctx.lineDashOffset = -Date.now() * 0.01;
        ctx.moveTo(w - 100, 200); ctx.quadraticCurveTo((w - 100 + p.x) / 2, 150, p.x, p.y); ctx.strokeStyle = color + '44'; ctx.lineWidth = 2; ctx.stroke(); ctx.setLineDash([]);
      });
    }

    function handleMouseMove(e) {
      const rect = canvas.getBoundingClientRect(), x = e.clientX - rect.left, y = e.clientY - rect.top;
      if (isPanning && lastPanPos) { panX += x - lastPanPos.x; panY += y - lastPanPos.y; lastPanPos = { x, y }; return; }
      if (dragNode) { const dx = x - (cx + panX), dy = y - (cy + panY); dragNode.angleDeg = Math.atan2(dy, dx) * 180 / Math.PI; return; }
      const node = nodePositions.find(p => Math.sqrt((x - p.x) ** 2 + (y - p.y) ** 2) < p.size);
      if (node) { canvas.style.cursor = 'pointer'; const n = CONFIG.nodes.find(v => v.id === node.id); if (n) showTooltip(n, e.clientX, e.clientY); }
      else { canvas.style.cursor = isPanning ? 'move' : (isEditorOpen ? 'crosshair' : 'default'); hideTooltip(); if (highlightedPathNodes.size > 0) highlightedPathNodes.clear(); }
    }

    function handleMouseDown(e) {
      const rect = canvas.getBoundingClientRect(), x = e.clientX - rect.left, y = e.clientY - rect.top;
      if (e.button === 1 || (e.button === 0 && e.altKey)) { isPanning = true; lastPanPos = { x, y }; canvas.classList.add('panning'); return; }
      const node = nodePositions.find(p => Math.sqrt((x - p.x) ** 2 + (y - p.y) ** 2) < p.size);
      if (node) { if (isEditorOpen) dragNode = CONFIG.nodes.find(v => v.id === node.id); selectNode(node.id); }
      else { selectedNodeId = null; if (isEditorOpen) document.getElementById('node-editor').style.display = 'none'; }
    }

    function handleMouseUp() { isPanning = false; dragNode = null; lastPanPos = null; canvas.classList.remove('panning'); }
    function handleMouseLeave() { handleMouseUp(); hideTooltip(); }
    function handleWheel(e) {
      e.preventDefault(); const delta = e.deltaY > 0 ? 0.9 : 1.1;
      const oldZoom = userZoom; userZoom = Math.max(0.25, Math.min(4, userZoom * delta));
      const rect = canvas.getBoundingClientRect(); const x = e.clientX - rect.left, y = e.clientY - rect.top;
      const sx = baseScale * oldZoom, nx = baseScale * userZoom;
      panX -= (x - cx - panX) * (nx / sx - 1); panY -= (y - cy - panY) * (nx / sx - 1);
    }

    function getPathToCore(id) { const p = []; let c = id; while (c) { p.push(c); if (c === 'CORE') break; const e = CONFIG.edges.find(x => x.to === c); c = e ? e.from : null; } return p; }
    function calculateTotalCost(ids) { const t = {}; ids.forEach(id => { const n = CONFIG.nodes.find(v => v.id === id); if (n && n.state === 'LOCKED') n.requirements?.forEach(r => { t[r.type] = (t[r.type] || 0) + r.count; }); }); return t; }

    function showTooltip(node, x, y) {
      highlightedPathNodes = new Set(getPathToCore(node.id)); const cost = calculateTotalCost(Array.from(highlightedPathNodes));
      let h = `<h3>${node.label.replace('\n', ' ')}</h3><span class="state ${node.state}">${getStateName(node.state)}</span><div class="description">${node.description || ''}</div>`;
      if (node.requirements?.length) { h += '<div class="requirements"><h4>å¿…è¦ã‚¹ãƒ•ã‚£ã‚¢</h4>'; node.requirements.forEach(r => { const c = CONFIG.sphereTypes[r.type]?.color || '#888'; h += `<span class="sphere-item" style="background:${c}22;color:${c};border:1px solid ${c}44">${r.type} Ã—${r.count}</span>`; }); h += '</div>'; }
      if (Object.keys(cost).length > 0) { h += `<div class="total-cost" style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(74, 122, 184, 0.2)"><h4 style="color:#FFD700; font-size:11px; margin-bottom:6px;">æœ€çŸ­ãƒ«ãƒ¼ãƒˆç´¯è¨ˆã‚³ã‚¹ãƒˆ</h4>`; Object.entries(cost).forEach(([t, c]) => { const cl = CONFIG.sphereTypes[t]?.color || '#888'; h += `<div style="display:inline-flex; align-items:center; margin-right:12px; font-size:11px;"><div style="width:8px; height:8px; border-radius:50%; background:${cl}; margin-right:6px; box-shadow:0 0 6px ${cl}"></div><span>${t} Ã—${c}</span></div>`; }); h += '</div>'; }
      if (node.effect) h += `<div class="effect">â†’ ${node.effect}</div>`;
      tooltip.innerHTML = h; tooltip.style.display = 'block'; const tr = tooltip.getBoundingClientRect();
      let l = x + 15, t = y + 15; if (l + tr.width > window.innerWidth) l = x - tr.width - 15; if (t + tr.height > window.innerHeight) t = y - tr.height - 15;
      tooltip.style.left = l + 'px'; tooltip.style.top = t + 'px';
    }

    function hideTooltip() { if (tooltip) tooltip.style.display = 'none'; }
    function getStateName(s) { return { MASTERED: 'å®šç€', UNLOCKED: 'è§£æ”¾æ¸ˆ', ELIGIBLE: 'è§£æ”¾å¯', LOCKED: 'æœªè§£æ”¾' }[s] || 'æœªè§£æ”¾'; }
    function lighten(hex, amt) { const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return m ? `rgb(${Math.min(255, parseInt(m[1], 16) + amt * 255)},${Math.min(255, parseInt(m[2], 16) + amt * 255)},${Math.min(255, parseInt(m[3], 16) + amt * 255)})` : hex; }
    function darken(hex, amt) { const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return m ? `rgb(${Math.max(0, parseInt(m[1], 16) - amt * 255)},${Math.max(0, parseInt(m[2], 16) - amt * 255)},${Math.max(0, parseInt(m[3], 16) - amt * 255)})` : hex; }


    // --- Editor & IO ---
    function toggleEditor() {
      isEditorOpen = !isEditorOpen; document.getElementById('editor-panel').classList.toggle('open', isEditorOpen);
      const btn = document.getElementById('editor-toggle'); btn.classList.toggle('active', isEditorOpen); btn.textContent = isEditorOpen ? 'âœ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰' : 'ğŸ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
      if (isEditorOpen) { updateRingList(); updateNodeList(); updateRingSelect(); }
    }

    function updateRingList() {
      const list = document.getElementById('ring-list'); list.innerHTML = '';
      CONFIG.rings.forEach((r, i) => {
        const item = document.createElement('div'); item.className = 'ring-item';
        item.innerHTML = `
          <div style="display:flex; flex-direction:column; gap:2px;"><button class="btn btn-secondary btn-small" onclick="moveRing(${i},-1)" ${i === 0 ? 'disabled' : ''}>â–²</button><button class="btn btn-secondary btn-small" onclick="moveRing(${i},1)" ${i === CONFIG.rings.length - 1 ? 'disabled' : ''}>â–¼</button></div>
          <input type="text" value="${r.label}" onchange="CONFIG.rings[${i}].label=this.value; draw()">
          <input type="number" value="${r.radius}" onchange="CONFIG.rings[${i}].radius=+this.value; draw()" style="width:50px">
          <button class="delete-ring" onclick="deleteRing(${i})">Ã—</button>`;
        list.appendChild(item);
      });
    }

    function moveRing(idx, d) { const n = idx + d; if (n < 0 || n >= CONFIG.rings.length) return;[CONFIG.rings[idx], CONFIG.rings[n]] = [CONFIG.rings[n], CONFIG.rings[idx]]; updateRingList(); updateRingSelect(); draw(); }
    function deleteRing(idx) { if (CONFIG.rings.length > 1) { CONFIG.rings.splice(idx, 1); updateRingList(); updateRingSelect(); draw(); } }
    function addNewRing() { const maxR = Math.max(...CONFIG.rings.map(r => r.radius)); CONFIG.rings.push({ id: 'R' + Date.now().toString(36), label: 'æ–°ãƒªãƒ³ã‚°', radius: maxR + 100 }); updateRingList(); updateRingSelect(); draw(); }
    function updateRingSelect() { document.getElementById('edit-ring').innerHTML = CONFIG.rings.map(r => `<option value="${r.id}">${r.label}</option>`).join(''); }

    function updateNodeList() {
      const list = document.getElementById('node-list'); list.innerHTML = '';
      CONFIG.nodes.filter(n => n.id !== 'CORE').forEach(node => {
        const item = document.createElement('div'); item.className = 'node-list-item' + (node.id === selectedNodeId ? ' selected' : '');
        item.onclick = () => selectNode(node.id);
        const c = node.state === 'MASTERED' ? '#FFD700' : (node.state === 'UNLOCKED' ? '#33E680' : '#8899aa');
        item.innerHTML = `<div class="node-dot" style="background:${c}"></div><span class="node-name">${node.label.replace('\n', ' ')}</span><span class="node-ring">${node.ring}</span>`;
        list.appendChild(item);
      });
      document.getElementById('edit-parent').innerHTML = '<option value="CORE">CORE</option>' + CONFIG.nodes.filter(n => n.id !== 'CORE').map(n => `<option value="${n.id}">${n.label.replace('\n', ' ')}</option>`).join('');
    }

    function selectNode(id) {
      selectedNodeId = id; const n = CONFIG.nodes.find(v => v.id === id); if (!n) return;
      document.getElementById('node-editor').style.display = 'block'; populateNodeEditor(n); updateNodeList(); draw();
    }

    function populateNodeEditor(n) {
      document.getElementById('edit-id').value = n.id; document.getElementById('edit-label').value = n.label.replace('\n', ' ');
      document.getElementById('edit-ring').value = n.ring; document.getElementById('edit-state').value = n.state;
      document.getElementById('edit-angle').value = n.angleDeg || 0; document.getElementById('edit-importance').value = n.importance;
      document.getElementById('edit-shape').value = n.shape; document.getElementById('edit-description').value = n.description || '';
      document.getElementById('edit-effect').value = n.effect || '';
      const se = document.getElementById('sphere-editor'); se.innerHTML = '';
      Object.entries(CONFIG.sphereTypes).forEach(([t, info]) => {
        const r = n.requirements?.find(x => x.type === t);
        se.innerHTML += `<div class="sphere-tag" style="background:${info.color}33;color:${info.color}">${t}<input type="number" min="0" max="10" value="${r ? r.count : 0}" data-type="${t}"></div>`;
      });
      const edge = CONFIG.edges.find(e => e.to === n.id); document.getElementById('edit-parent').value = edge ? edge.from : 'CORE';
    }

    function saveNode() {
      const n = CONFIG.nodes.find(v => v.id === selectedNodeId); if (!n) return;
      n.label = document.getElementById('edit-label').value.replace(/ /g, '\n'); n.ring = document.getElementById('edit-ring').value;
      n.state = document.getElementById('edit-state').value; n.angleDeg = +document.getElementById('edit-angle').value;
      n.importance = document.getElementById('edit-importance').value; n.shape = document.getElementById('edit-shape').value;
      n.description = document.getElementById('edit-description').value; n.effect = document.getElementById('edit-effect').value;
      n.requirements = []; document.querySelectorAll('#sphere-editor input').forEach(i => { if (+i.value > 0) n.requirements.push({ type: i.dataset.type, count: +i.value }); });
      const pid = document.getElementById('edit-parent').value, ei = CONFIG.edges.findIndex(e => e.to === n.id);
      if (ei >= 0) CONFIG.edges[ei].from = pid; else CONFIG.edges.push({ from: pid, to: n.id, type: 'MAIN' });
      updateNodeList(); draw();
    }

    function deleteNode() {
      if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; CONFIG.nodes = CONFIG.nodes.filter(n => n.id !== selectedNodeId);
      CONFIG.edges = CONFIG.edges.filter(e => e.from !== selectedNodeId && e.to !== selectedNodeId);
      selectedNodeId = null; document.getElementById('node-editor').style.display = 'none'; updateNodeList(); draw();
    }

    function exportData() {
      const blob = new Blob([JSON.stringify({ rings: CONFIG.rings, nodes: CONFIG.nodes, edges: CONFIG.edges }, null, 2)], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'sphere-grid.json'; a.click();
    }

    function importData() {
      const i = document.createElement('input'); i.type = 'file'; i.accept = '.json';
      i.onchange = e => {
        const r = new FileReader(); r.onload = ev => {
          try {
            const d = JSON.parse(ev.target.result); if (d.rings) CONFIG.rings = d.rings; if (d.nodes) CONFIG.nodes = d.nodes; if (d.edges) CONFIG.edges = d.edges;
            updateRingList(); updateNodeList(); updateRingSelect(); draw(); alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
          } catch { alert('ã‚¨ãƒ©ãƒ¼'); }
        }; r.readAsText(e.target.files[0]);
      }; i.click();
    }
    function downloadImage() { const a = document.createElement('a'); a.download = 'grid.png'; a.href = canvas.toDataURL('image/png'); a.click(); }
  </script>
</body>

</html>